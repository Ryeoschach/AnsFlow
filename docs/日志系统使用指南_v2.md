# AnsFlow 统一日志系统使用指南 v2.0

## 1. 目录结构

```
logs/
├── services/           # 按服务分类的日志文件
│   ├── django/        # Django服务日志
│   ├── fastapi/       # FastAPI服务日志
│   └── system/        # 系统监控日志
├── aggregated/        # 聚合后的日志文件
└── archived/          # 归档的历史日志
```

## 2. 日志文件命名规范

- 主日志: `{service}_main.log`
- 错误日志: `{service}_error.log`
- 访问日志: `{service}_access.log`
- 性能日志: `{service}_performance.log`

## 3. 配置文件说明

### 3.1 环境配置 (.env.logging)
```bash
LOG_DIR=/path/to/logs     # 日志目录
LOG_LEVEL=INFO            # 日志级别
LOG_FORMAT=json           # 日志格式 (json/text)
LOG_RETENTION_DAYS=30     # 保留天数
```

## 4. 使用方法

### 4.1 Django服务
```python
from common.django_logging_config import get_logger, log_performance

# 获取日志器
logger = get_logger('ansflow.views', component='user_management')
logger.info("用户登录", extra={'user_id': 123, 'ip': '192.168.1.1'})

# 性能监控装饰器
@log_performance()
def slow_function():
    # 耗时操作
    pass
```

### 4.2 FastAPI服务
```python
from core.fastapi_logging_config import get_logger, log_performance

# 获取结构化日志器
logger = get_logger('ansflow.api', component='auth')
logger.info("API调用", user_id=123, endpoint="/api/users")

# 异步性能监控
@log_performance()
async def api_handler():
    # API处理逻辑
    pass
```

### 4.3 系统监控
```python
from monitoring.system_logging_config import get_system_logger

# 获取系统监控日志器
system_logger = get_system_logger()

# 记录系统指标
system_logger.log_system_metrics()

# 记录Docker指标
system_logger.log_docker_metrics()
```

## 5. 日志聚合和归档

### 5.1 手动执行
```bash
# 聚合日志
python3 scripts/log_aggregator.py --aggregate

# 归档旧日志
python3 scripts/log_aggregator.py --archive

# 生成报告
python3 scripts/log_aggregator.py --report

# 执行所有操作
python3 scripts/log_aggregator.py --all
```

### 5.2 定时任务
```bash
# 安装定时任务
crontab scripts/crontab.example
```

## 6. 启动系统监控
```bash
# 启动系统监控
python3 scripts/system_monitor.py
```

## 7. 日志查询示例

### 7.1 查看今日错误日志
```bash
python3 scripts/log_aggregator.py --aggregate
cat logs/aggregated/errors_only_$(date +%Y%m%d).log | jq '.'
```

### 7.2 查看性能日志
```bash
cat logs/aggregated/performance_combined_$(date +%Y%m%d).log | jq '.response_time_ms'
```

### 7.3 查看特定服务日志
```bash
tail -f logs/services/django/django_main.log | jq '.'
```

## 8. 故障排查

### 8.1 日志文件不生成
- 检查目录权限
- 检查环境变量配置
- 查看控制台错误信息

### 8.2 日志格式错误
- 验证LOG_FORMAT环境变量
- 检查JSON格式化器配置

### 8.3 性能问题
- 调整LOG_LEVEL到WARNING减少日志量
- 启用日志压缩和归档
- 检查磁盘空间

## 9. 最佳实践

1. **结构化日志**: 使用JSON格式便于查询分析
2. **组件标识**: 为每个日志器指定component
3. **敏感数据**: 避免记录密码、令牌等敏感信息
4. **性能监控**: 对关键功能使用性能装饰器
5. **定期维护**: 配置自动归档和清理任务
