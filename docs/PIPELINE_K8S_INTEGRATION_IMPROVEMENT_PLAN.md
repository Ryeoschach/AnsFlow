# AnsFlow æµæ°´çº¿ Kubernetes é›†æˆå®Œå–„è®¡åˆ’

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æäº† AnsFlow æµæ°´çº¿ç³»ç»Ÿä¸­ Kubernetes é›†æˆçš„ç°çŠ¶ï¼Œå¹¶æä¾›äº†å®Œå–„è®¡åˆ’å’ŒåŠŸèƒ½å¢å¼ºå»ºè®®ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´8æœˆ12æ—¥  
**æ›´æ–°æ—¥æœŸ**: 2025å¹´8æœˆ12æ—¥  
**ç»´æŠ¤äººå‘˜**: AnsFlow å¼€å‘å›¢é˜Ÿ

---

## ğŸ¯ å½“å‰é›†æˆçŠ¶æ€è¯„ä¼°

### âœ… å·²å®ŒæˆåŠŸèƒ½

#### 1. åç«¯æ¶æ„å±‚é¢
- **æ•°æ®æ¨¡å‹å®Œå–„** - `PipelineStep` æ¨¡å‹æ”¯æŒå®Œæ•´çš„ K8s å­—æ®µ
  - `k8s_cluster` - å…³è” KubernetesCluster å¤–é”®
  - `k8s_namespace` - å‘½åç©ºé—´å­—æ®µ
  - `k8s_resource_name` - èµ„æºåç§°å­—æ®µ
  - `k8s_config` - K8s ç‰¹å®šé…ç½® JSON å­—æ®µ

- **æ‰§è¡Œå™¨å®Œæ•´å®ç°** - `KubernetesStepExecutor` æ”¯æŒ 6 ç§æ ¸å¿ƒæ“ä½œ
  - `k8s_deploy` - åº”ç”¨éƒ¨ç½²åˆ°é›†ç¾¤
  - `k8s_scale` - æ‰©ç¼©å®¹ç®¡ç†
  - `k8s_delete` - èµ„æºåˆ é™¤
  - `k8s_wait` - ç­‰å¾…æ¡ä»¶æ»¡è¶³
  - `k8s_exec` - Pod å†…å‘½ä»¤æ‰§è¡Œ
  - `k8s_logs` - æ—¥å¿—è·å–

- **é›†æˆå±‚å®Œå–„** - ä¸ç°æœ‰æµæ°´çº¿ç³»ç»Ÿæ— ç¼é›†æˆ
  - `LocalExecutor` å·²é›†æˆ `KubernetesStepExecutor`
  - é€šè¿‡ `KubernetesManager` ç»Ÿä¸€è°ƒç”¨ K8s API
  - æ”¯æŒå˜é‡æ›¿æ¢å’Œä¸Šä¸‹æ–‡ä¼ é€’

#### 2. å‰ç«¯ç•Œé¢å±‚é¢
- **é…ç½®å®šä¹‰å®Œæ•´** - `pipeline-steps-config.json` åŒ…å«å®Œæ•´é…ç½®
  - 6 ç§ K8s æ­¥éª¤ç±»å‹çš„è¯¦ç»†å‚æ•°å®šä¹‰
  - Jenkins Pipeline è½¬æ¢ç¤ºä¾‹
  - å‚æ•°éªŒè¯å’Œä¼˜å…ˆçº§è®¾ç½®

- **UI ç»„ä»¶å®ç°** - ä¸“ç”¨çš„ K8s é…ç½®ç»„ä»¶
  - `KubernetesStepConfig.tsx` - ä¸“é—¨çš„ K8s æ­¥éª¤é…ç½®ç•Œé¢
  - æ”¯æŒé›†ç¾¤é€‰æ‹©ã€å‘½åç©ºé—´è®¾ç½®ã€èµ„æºé…ç½®
  - è¡¨å•éªŒè¯å’Œç”¨æˆ·å‹å¥½çš„è¾“å…¥ä½“éªŒ

- **é›†ç¾¤ç®¡ç†å®Œå–„** - å®Œæ•´çš„é›†ç¾¤ç®¡ç†åŠŸèƒ½
  - `KubernetesSettings.tsx` - é›†ç¾¤ CRUD ç®¡ç†ç•Œé¢
  - é›†ç¾¤è¿æ¥æµ‹è¯•ã€èµ„æºåŒæ­¥ç­‰åŠŸèƒ½
  - å®æ—¶é›†ç¾¤ç»Ÿè®¡ä¿¡æ¯å±•ç¤º

### ğŸ“Š å®Œæˆåº¦ç»Ÿè®¡
| åŠŸèƒ½æ¨¡å— | å®Œæˆåº¦ | çŠ¶æ€ |
|---------|--------|------|
| åç«¯æ ¸å¿ƒåŠŸèƒ½ | 90% | âœ… åŸºæœ¬å®Œæˆ |
| å‰ç«¯ UI ç»„ä»¶ | 85% | âœ… åŸºæœ¬å®Œæˆ |
| é›†æˆè”è°ƒ | 60% | ğŸš§ éœ€è¦å®Œå–„ |
| ç”¨æˆ·ä½“éªŒ | 70% | ğŸš§ éœ€è¦ä¼˜åŒ– |
| **æ€»ä½“å®Œæˆåº¦** | **76%** | ğŸš§ **è‰¯å¥½åŸºç¡€ï¼Œéœ€è¦å®Œå–„** |

---

## ğŸš¨ æ€¥éœ€ä¿®å¤çš„é—®é¢˜

### 1. ğŸ”´ é«˜ä¼˜å…ˆçº§ - é›†ç¾¤æ•°æ®è·å–ç¼ºå¤±

**é—®é¢˜æè¿°**:
```typescript
// å½“å‰é—®é¢˜ï¼šPipelineStepForm ç»„ä»¶éœ€è¦ k8sClusters æ•°æ®ä½†æœªä» API è·å–
// å½±å“ï¼šç”¨æˆ·æ— æ³•åœ¨æµæ°´çº¿ç¼–è¾‘å™¨ä¸­é€‰æ‹© Kubernetes é›†ç¾¤
```

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// åœ¨ PipelineStepForm.tsx ä¸­æ·»åŠ ï¼š
useEffect(() => {
  const fetchK8sClusters = async () => {
    try {
      const clusters = await apiService.getKubernetesClusters();
      setK8sClusters(clusters);
    } catch (error) {
      console.error('è·å– K8s é›†ç¾¤å¤±è´¥:', error);
    }
  };
  fetchK8sClusters();
}, []);
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æµæ°´çº¿ç¼–è¾‘å™¨ä¸­ K8s æ­¥éª¤å¯ä»¥æ­£å¸¸æ˜¾ç¤ºé›†ç¾¤é€‰æ‹©ä¸‹æ‹‰æ¡†
- [ ] ä¸‹æ‹‰æ¡†åŒ…å«æ‰€æœ‰å¯ç”¨çš„ Kubernetes é›†ç¾¤
- [ ] é€‰æ‹©é›†ç¾¤åèƒ½æ­£ç¡®ä¿å­˜åˆ°æ­¥éª¤é…ç½®ä¸­

### 2. ğŸ”´ é«˜ä¼˜å…ˆçº§ - å‘½åç©ºé—´è”åŠ¨åŠ è½½

**é—®é¢˜æè¿°**:
```typescript
// å½“å‰é—®é¢˜ï¼šé€‰æ‹©é›†ç¾¤åï¼Œå‘½åç©ºé—´ä¸‹æ‹‰æ¡†æ²¡æœ‰åŠ¨æ€æ›´æ–°
// å½±å“ï¼šç”¨æˆ·åªèƒ½æ‰‹åŠ¨è¾“å…¥å‘½åç©ºé—´ï¼Œä½“éªŒä¸ä½³
```

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// åœ¨ KubernetesStepConfig.tsx ä¸­æ·»åŠ é›†ç¾¤å˜åŒ–ç›‘å¬ï¼š
const handleClusterChange = async (clusterId: number) => {
  try {
    const namespaces = await apiService.getKubernetesClusterNamespaces(clusterId);
    setK8sNamespaces(namespaces);
    // é‡ç½®å‘½åç©ºé—´é€‰æ‹©
    form.setFieldsValue({ k8s_namespace: undefined });
  } catch (error) {
    console.error('è·å–å‘½åç©ºé—´å¤±è´¥:', error);
  }
};
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] é€‰æ‹©é›†ç¾¤åè‡ªåŠ¨åŠ è½½è¯¥é›†ç¾¤çš„å‘½åç©ºé—´åˆ—è¡¨
- [ ] å‘½åç©ºé—´ä¸‹æ‹‰æ¡†æ˜¾ç¤ºçœŸå®çš„é›†ç¾¤å‘½åç©ºé—´
- [ ] åˆ‡æ¢é›†ç¾¤æ—¶è‡ªåŠ¨é‡ç½®å‘½åç©ºé—´é€‰æ‹©

### 3. ğŸ”´ é«˜ä¼˜å…ˆçº§ - è¡¨å•æ•°æ®ç»‘å®šå®Œå–„

**é—®é¢˜æè¿°**:
```typescript
// å½“å‰é—®é¢˜ï¼šK8s ç›¸å…³å­—æ®µä¸ Form ç»„ä»¶çš„æ•°æ®ç»‘å®šä¸å®Œæ•´
// å½±å“ï¼šé…ç½®ä¿å­˜å’Œå›æ˜¾å¯èƒ½å­˜åœ¨é—®é¢˜
```

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿æ‰€æœ‰ K8s å­—æ®µæ­£ç¡®æ˜ å°„åˆ° Form.Item çš„ name å±æ€§
- æ·»åŠ è¡¨å•æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†
- å®Œå–„æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–é€»è¾‘

---

## ğŸ› ï¸ ä¸­æœŸå®Œå–„è®¡åˆ’

### 1. ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ - é…ç½®éªŒè¯å’Œé¢„è§ˆ

**åŠŸèƒ½æè¿°**:
- ç”¨æˆ·è¾“å…¥ K8s é…ç½®åæä¾›å®æ—¶éªŒè¯
- æ”¯æŒ YAML é…ç½®çš„è¯­æ³•æ£€æŸ¥
- æä¾›éƒ¨ç½²é…ç½®çš„é¢„è§ˆåŠŸèƒ½

**å®ç°æ–¹æ¡ˆ**:
```typescript
// æ·»åŠ é…ç½®éªŒè¯ç»„ä»¶
const validateK8sConfig = (config: any) => {
  // YAML è¯­æ³•éªŒè¯
  // å¿…å¡«å­—æ®µæ£€æŸ¥
  // èµ„æºåç§°æ ¼å¼éªŒè¯
  return validationResult;
};

// æ·»åŠ é¢„è§ˆæ¨¡æ€æ¡†
const K8sConfigPreview = ({ config }) => {
  return (
    <Modal title="é…ç½®é¢„è§ˆ">
      <CodeMirror
        value={generateK8sYaml(config)}
        options={{ mode: 'yaml', readOnly: true }}
      />
    </Modal>
  );
};
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] å®æ—¶éªŒè¯ç”¨æˆ·è¾“å…¥çš„é…ç½®
- [ ] æä¾›å‹å¥½çš„é”™è¯¯æç¤ºä¿¡æ¯
- [ ] æ”¯æŒ YAML é…ç½®é¢„è§ˆåŠŸèƒ½

### 2. ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ - æ‰§è¡ŒçŠ¶æ€ç›‘æ§

**åŠŸèƒ½æè¿°**:
- æµæ°´çº¿æ‰§è¡Œæ—¶æ˜¾ç¤º K8s èµ„æºçš„å®æ—¶çŠ¶æ€
- é›†æˆ WebSocket æ¨é€éƒ¨ç½²è¿›åº¦
- æä¾›è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯

**å®ç°æ–¹æ¡ˆ**:
```python
# åç«¯æ·»åŠ  WebSocket æ”¯æŒ
class K8sExecutionMonitor:
    def monitor_deployment(self, deployment_name, namespace):
        # ç›‘æ§éƒ¨ç½²çŠ¶æ€å˜åŒ–
        # é€šè¿‡ WebSocket æ¨é€çŠ¶æ€æ›´æ–°
        pass

# å‰ç«¯æ·»åŠ å®æ—¶çŠ¶æ€ç»„ä»¶
const K8sExecutionStatus = ({ stepId }) => {
  const [status, setStatus] = useState(null);
  
  useEffect(() => {
    const ws = new WebSocket(`ws://api/k8s/monitor/${stepId}`);
    ws.onmessage = (event) => {
      setStatus(JSON.parse(event.data));
    };
  }, [stepId]);
  
  return <StatusDisplay status={status} />;
};
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰§è¡Œæ—¶æ˜¾ç¤º Pod çŠ¶æ€å˜åŒ–
- [ ] å®æ—¶æ›´æ–°éƒ¨ç½²è¿›åº¦
- [ ] æä¾›è¯¦ç»†çš„é”™è¯¯è¯Šæ–­ä¿¡æ¯

### 3. ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ - é…ç½®æ¨¡æ¿åŒ–

**åŠŸèƒ½æè¿°**:
- æä¾›å¸¸ç”¨éƒ¨ç½²é…ç½®æ¨¡æ¿
- æ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿çš„åˆ›å»ºå’Œç®¡ç†
- æ¨¡æ¿çš„å¯¼å…¥å¯¼å‡ºåŠŸèƒ½

**å®ç°æ–¹æ¡ˆ**:
```typescript
// é…ç½®æ¨¡æ¿ç®¡ç†
interface K8sTemplate {
  id: string;
  name: string;
  description: string;
  category: 'web-app' | 'microservice' | 'job' | 'custom';
  config: any;
}

const K8sTemplateSelector = ({ onSelect }) => {
  const [templates, setTemplates] = useState<K8sTemplate[]>([]);
  
  return (
    <Select placeholder="é€‰æ‹©é…ç½®æ¨¡æ¿">
      {templates.map(template => (
        <Option key={template.id} value={template}>
          {template.name} - {template.description}
        </Option>
      ))}
    </Select>
  );
};
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æä¾›è‡³å°‘ 5 ä¸ªå¸¸ç”¨éƒ¨ç½²æ¨¡æ¿
- [ ] æ”¯æŒæ¨¡æ¿çš„å¢åˆ æ”¹æŸ¥
- [ ] æ¨¡æ¿åº”ç”¨åå¯ä»¥è¿›ä¸€æ­¥è‡ªå®šä¹‰

---

## ğŸš€ é•¿æœŸåŠŸèƒ½å¢å¼º

### 1. ğŸŸ¢ ä½ä¼˜å…ˆçº§ - é«˜çº§éƒ¨ç½²ç­–ç•¥

**åŠŸèƒ½æè¿°**:
- æ”¯æŒè“ç»¿éƒ¨ç½²ã€é‡‘ä¸é›€éƒ¨ç½²ç­‰é«˜çº§ç­–ç•¥
- é›†æˆ Helm Charts éƒ¨ç½²
- æ”¯æŒå¤šé›†ç¾¤éƒ¨ç½²ç®¡ç†

**æŠ€æœ¯æ–¹æ¡ˆ**:
```python
class AdvancedDeploymentStrategies:
    def blue_green_deploy(self, config):
        # è“ç»¿éƒ¨ç½²é€»è¾‘
        pass
    
    def canary_deploy(self, config):
        # é‡‘ä¸é›€éƒ¨ç½²é€»è¾‘
        pass
    
    def helm_deploy(self, chart_config):
        # Helm éƒ¨ç½²é€»è¾‘
        pass
```

### 2. ğŸŸ¢ ä½ä¼˜å…ˆçº§ - èµ„æºç›‘æ§é›†æˆ

**åŠŸèƒ½æè¿°**:
- é›†æˆ Prometheus ç›‘æ§æ•°æ®
- æ˜¾ç¤ºèµ„æºä½¿ç”¨æƒ…å†µå›¾è¡¨
- æ€§èƒ½æŒ‡æ ‡å’Œå‘Šè­¦é›†æˆ

### 3. ğŸŸ¢ ä½ä¼˜å…ˆçº§ - å®‰å…¨å¢å¼º

**åŠŸèƒ½æè¿°**:
- RBAC æƒé™æ§åˆ¶
- æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- å®¡è®¡æ—¥å¿—è®°å½•

---

## ğŸ“… å¼€å‘æ’æœŸå»ºè®®

### ç¬¬ä¸€é˜¶æ®µ - æ€¥éœ€ä¿®å¤ (1-2 å‘¨)
- [ ] **Week 1**: ä¿®å¤é›†ç¾¤æ•°æ®è·å–ç¼ºå¤±é—®é¢˜
- [ ] **Week 1**: å®ç°å‘½åç©ºé—´è”åŠ¨åŠ è½½
- [ ] **Week 2**: å®Œå–„è¡¨å•æ•°æ®ç»‘å®š

### ç¬¬äºŒé˜¶æ®µ - ä¸­æœŸå®Œå–„ (3-6 å‘¨)
- [ ] **Week 3-4**: é…ç½®éªŒè¯å’Œé¢„è§ˆåŠŸèƒ½
- [ ] **Week 5**: æ‰§è¡ŒçŠ¶æ€ç›‘æ§åŸºç¡€æ¡†æ¶
- [ ] **Week 6**: é…ç½®æ¨¡æ¿åŒ–åŠŸèƒ½

### ç¬¬ä¸‰é˜¶æ®µ - é•¿æœŸå¢å¼º (7-12 å‘¨)
- [ ] **Week 7-9**: é«˜çº§éƒ¨ç½²ç­–ç•¥å®ç°
- [ ] **Week 10-11**: èµ„æºç›‘æ§é›†æˆ
- [ ] **Week 12**: å®‰å…¨å¢å¼ºå’Œå®¡è®¡åŠŸèƒ½

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
```bash
# åç«¯æµ‹è¯•
python manage.py test kubernetes_integration.tests
python manage.py test pipelines.tests.test_kubernetes_executor

# å‰ç«¯æµ‹è¯•
npm test -- KubernetesStepConfig.test.tsx
npm test -- PipelineStepForm.test.tsx
```

### é›†æˆæµ‹è¯•
- [ ] ç«¯åˆ°ç«¯æµæ°´çº¿æ‰§è¡Œæµ‹è¯•
- [ ] K8s é›†ç¾¤è¿æ¥æµ‹è¯•
- [ ] å¤šé›†ç¾¤ç¯å¢ƒæµ‹è¯•

### æ€§èƒ½æµ‹è¯•
- [ ] å¤§è§„æ¨¡éƒ¨ç½²æ€§èƒ½æµ‹è¯•
- [ ] å¹¶å‘æ‰§è¡Œæµ‹è¯•
- [ ] èµ„æºä½¿ç”¨ç›‘æ§

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### æŠ€æœ¯æ–‡æ¡£
- [Kubernetes é›†æˆ API æ–‡æ¡£](./api/kubernetes-integration.md)
- [æµæ°´çº¿æ‰§è¡Œå™¨å¼€å‘æŒ‡å—](./pipeline-executor-guide.md)
- [å‰ç«¯ç»„ä»¶å¼€å‘è§„èŒƒ](./frontend-component-standards.md)

### ç”¨æˆ·æ–‡æ¡£
- [Kubernetes æ­¥éª¤ä½¿ç”¨æŒ‡å—](./user-guide/kubernetes-steps.md)
- [é›†ç¾¤ç®¡ç†æ“ä½œæ‰‹å†Œ](./user-guide/cluster-management.md)
- [æ•…éšœæ’é™¤æŒ‡å—](./user-guide/troubleshooting.md)

---

## ğŸ¤ å›¢é˜Ÿåä½œ

### è´£ä»»åˆ†å·¥
- **åç«¯å¼€å‘**: K8s æ‰§è¡Œå™¨ä¼˜åŒ–ã€API å®Œå–„
- **å‰ç«¯å¼€å‘**: UI ç»„ä»¶å®Œå–„ã€ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- **æµ‹è¯•å·¥ç¨‹å¸ˆ**: è‡ªåŠ¨åŒ–æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•
- **è¿ç»´å·¥ç¨‹å¸ˆ**: é›†ç¾¤ç¯å¢ƒå‡†å¤‡ã€ç›‘æ§é…ç½®

### ä»£ç å®¡æŸ¥è¦æ±‚
- [ ] æ‰€æœ‰ K8s ç›¸å…³ä»£ç å¿…é¡»é€šè¿‡å®‰å…¨å®¡æŸ¥
- [ ] UI ç»„ä»¶éœ€è¦è¿›è¡Œå¯è®¿é—®æ€§æµ‹è¯•
- [ ] æ€§èƒ½å…³é”®è·¯å¾„éœ€è¦è¿›è¡Œ Profile åˆ†æ

---

## ğŸ“ˆ æˆåŠŸæŒ‡æ ‡

### åŠŸèƒ½æŒ‡æ ‡
- [ ] æµæ°´çº¿ K8s æ­¥éª¤æ‰§è¡ŒæˆåŠŸç‡ > 95%
- [ ] ç”¨æˆ·é…ç½®é”™è¯¯ç‡ < 5%
- [ ] å¹³å‡éƒ¨ç½²æ—¶é—´ < 5 åˆ†é’Ÿ

### ç”¨æˆ·ä½“éªŒæŒ‡æ ‡
- [ ] UI å“åº”æ—¶é—´ < 2 ç§’
- [ ] ç”¨æˆ·æ»¡æ„åº¦ > 4.5/5
- [ ] æ–°ç”¨æˆ·ä¸Šæ‰‹æ—¶é—´ < 30 åˆ†é’Ÿ

### æŠ€æœ¯æŒ‡æ ‡
- [ ] ä»£ç è¦†ç›–ç‡ > 80%
- [ ] API å“åº”æ—¶é—´ < 500ms
- [ ] ç³»ç»Ÿå¯ç”¨æ€§ > 99.9%

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š
- **å¼€å‘å›¢é˜Ÿ**: dev@ansflow.com
- **äº§å“å›¢é˜Ÿ**: product@ansflow.com
- **æŠ€æœ¯æ”¯æŒ**: support@ansflow.com

---

*æœ¬æ–‡æ¡£å°†æ ¹æ®å¼€å‘è¿›åº¦å®šæœŸæ›´æ–°ï¼Œè¯·å…³æ³¨ç‰ˆæœ¬å˜åŒ–ã€‚*
