# Kubernetes é›†ç¾¤ç®¡ç†åŠŸèƒ½å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ¬¡å¼€å‘å®Œæˆäº† AnsFlow é¡¹ç›®ä¸­çš„ Kubernetes é›†ç¾¤ç®¡ç†åŠŸèƒ½ï¼Œå°†åŸæœ‰çš„æ¨¡æ‹Ÿæ•°æ®æ›¿æ¢ä¸ºçœŸå®çš„ Kubernetes API é›†æˆï¼Œå®ç°äº†å®Œæ•´çš„é›†ç¾¤æ·»åŠ ã€éªŒè¯ã€ç®¡ç†å’Œç›‘æ§åŠŸèƒ½ã€‚

## ğŸ¯ å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

### 1. åç«¯ API åŠŸèƒ½ (Django + FastAPI)

#### 1.1 é›†ç¾¤ç®¡ç†
- âœ… **å¤šç§è®¤è¯æ–¹å¼æ”¯æŒ**
  - Bearer Token è®¤è¯
  - Kubeconfig æ–‡ä»¶è®¤è¯
  - å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯
- âœ… **é›†ç¾¤è¿æ¥éªŒè¯**
  - åˆ›å»ºå‰é¢„éªŒè¯åŠŸèƒ½
  - å®æ—¶è¿æ¥çŠ¶æ€æ£€æŸ¥
  - å¼‚æ­¥ä»»åŠ¡çŠ¶æ€ç›‘æ§
- âœ… **é›†ç¾¤ä¿¡æ¯è·å–**
  - Kubernetes ç‰ˆæœ¬ä¿¡æ¯
  - èŠ‚ç‚¹ç»Ÿè®¡ï¼ˆæ€»æ•°/å°±ç»ªæ•°ï¼‰
  - Pod ç»Ÿè®¡ï¼ˆæ€»æ•°/è¿è¡Œæ•°ï¼‰

#### 1.2 æ•°æ®æ¨¡å‹
- âœ… `KubernetesCluster` - é›†ç¾¤ç®¡ç†
- âœ… `KubernetesNamespace` - å‘½åç©ºé—´ç®¡ç†
- âœ… `KubernetesDeployment` - éƒ¨ç½²ç®¡ç†
- âœ… `KubernetesService` - æœåŠ¡ç®¡ç†
- âœ… `KubernetesPod` - Pod ç®¡ç†
- âœ… `KubernetesConfigMap` - é…ç½®ç®¡ç†
- âœ… `KubernetesSecret` - å¯†é’¥ç®¡ç†

#### 1.3 API ç«¯ç‚¹
```
GET    /api/kubernetes/clusters/          # é›†ç¾¤åˆ—è¡¨
POST   /api/kubernetes/clusters/          # åˆ›å»ºé›†ç¾¤
GET    /api/kubernetes/clusters/{id}/     # é›†ç¾¤è¯¦æƒ…
PUT    /api/kubernetes/clusters/{id}/     # æ›´æ–°é›†ç¾¤
DELETE /api/kubernetes/clusters/{id}/     # åˆ é™¤é›†ç¾¤
POST   /api/kubernetes/clusters/validate-connection/  # éªŒè¯è¿æ¥
POST   /api/kubernetes/clusters/{id}/check-connection/ # æ£€æŸ¥è¿æ¥
POST   /api/kubernetes/clusters/{id}/sync-resources/   # åŒæ­¥èµ„æº
GET    /api/kubernetes/namespaces/        # å‘½åç©ºé—´åˆ—è¡¨
POST   /api/kubernetes/namespaces/        # åˆ›å»ºå‘½åç©ºé—´
```

### 2. å‰ç«¯åŠŸèƒ½ (React + TypeScript + Ant Design)

#### 2.1 é›†ç¾¤ç®¡ç†ç•Œé¢
- âœ… **é›†ç¾¤åˆ—è¡¨å±•ç¤º**
  - çŠ¶æ€å®æ—¶æ˜¾ç¤ºï¼ˆè¿æ¥/æ–­å¼€/é”™è¯¯ï¼‰
  - é›†ç¾¤åŸºæœ¬ä¿¡æ¯å±•ç¤º
  - æ“ä½œæŒ‰é’®ï¼ˆç¼–è¾‘/åˆ é™¤/åˆ·æ–°ï¼‰
- âœ… **é›†ç¾¤æ·»åŠ /ç¼–è¾‘**
  - åŠ¨æ€è¡¨å•æ”¯æŒå¤šç§è®¤è¯æ–¹å¼
  - å®æ—¶è¿æ¥éªŒè¯
  - è¡¨å•éªŒè¯å’Œé”™è¯¯å¤„ç†
- âœ… **ç»Ÿè®¡é¢æ¿**
  - é›†ç¾¤æ€»æ•°ç»Ÿè®¡
  - è¿æ¥çŠ¶æ€ç»Ÿè®¡
  - å‘½åç©ºé—´ç»Ÿè®¡

#### 2.2 å‘½åç©ºé—´ç®¡ç†
- âœ… å‘½åç©ºé—´åˆ—è¡¨å±•ç¤º
- âœ… å‘½åç©ºé—´åˆ›å»º/ç¼–è¾‘
- âœ… ä¸é›†ç¾¤çš„å…³è”ç®¡ç†

### 3. æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶

#### 3.1 Kubernetes å®¢æˆ·ç«¯å°è£… (`k8s_client.py`)
```python
class KubernetesManager:
    """Kubernetes ç®¡ç†å™¨"""
    
    def __init__(self, cluster):
        """æ”¯æŒå¤šç§è®¤è¯æ–¹å¼åˆå§‹åŒ–"""
        
    def get_cluster_info(self):
        """è·å–é›†ç¾¤ä¿¡æ¯ï¼ŒåŒ…å«ç‰ˆæœ¬ã€èŠ‚ç‚¹ã€Pod ç»Ÿè®¡"""
        
    def _init_from_token(self, auth_config):
        """Token è®¤è¯åˆå§‹åŒ–"""
        
    def _init_from_kubeconfig(self, auth_config):
        """Kubeconfig è®¤è¯åˆå§‹åŒ–"""
        
    def _init_from_cert(self, auth_config):
        """è¯ä¹¦è®¤è¯åˆå§‹åŒ–"""
```

#### 3.2 å¼‚æ­¥ä»»åŠ¡ç³»ç»Ÿ (`tasks.py`)
```python
@shared_task(bind=True, max_retries=3)
def check_cluster_status(self, cluster_id):
    """å¼‚æ­¥æ£€æŸ¥é›†ç¾¤çŠ¶æ€"""
    
@shared_task(bind=True)
def sync_cluster_resources(self, cluster_id):
    """å¼‚æ­¥åŒæ­¥é›†ç¾¤èµ„æº"""
```

#### 3.3 æ•°æ®éªŒè¯ (`serializers.py`)
```python
class KubernetesClusterValidationSerializer(serializers.Serializer):
    """é›†ç¾¤è¿æ¥éªŒè¯åºåˆ—åŒ–å™¨"""
    
    def validate_auth_config(self, value):
        """éªŒè¯è®¤è¯é…ç½®çš„å®Œæ•´æ€§"""
```

### 4. å‰ç«¯ API æœåŠ¡ (`api.ts`)
```typescript
// Kubernetes é›†ç¾¤ç®¡ç†
validateKubernetesConnection(data: any)
getKubernetesClusters()
createKubernetesCluster(data: any)
updateKubernetesCluster(id: number, data: any)
deleteKubernetesCluster(id: number)
checkKubernetesClusterConnection(id: number)

// å‘½åç©ºé—´ç®¡ç†
getKubernetesNamespaces()
createKubernetesNamespace(data: any)
updateKubernetesNamespace(id: number, data: any)
deleteKubernetesNamespace(id: number)
```

## ğŸ§ª æµ‹è¯•åŠŸèƒ½

### æµ‹è¯•å·¥å…·
- âœ… **Django ç®¡ç†å‘½ä»¤**
  - `python manage.py test_k8s_connection --all` - æµ‹è¯•æ‰€æœ‰é›†ç¾¤è¿æ¥
  - `python manage.py create_test_clusters` - åˆ›å»ºæµ‹è¯•æ•°æ®

### æµ‹è¯•æ•°æ®
- âœ… åˆ›å»ºäº† 3 ä¸ªæµ‹è¯•é›†ç¾¤ï¼ˆå¼€å‘/ç”Ÿäº§/æµ‹è¯•ç¯å¢ƒï¼‰
- âœ… æ”¯æŒä¸åŒè®¤è¯æ–¹å¼çš„æµ‹è¯•åœºæ™¯
- âœ… æ¨¡æ‹Ÿæ¨¡å¼å…¼å®¹ï¼ˆå½“ kubernetes åº“ä¸å¯ç”¨æ—¶ï¼‰

## ğŸ”§ æŠ€æœ¯æ ˆ

### åç«¯
- **Django 4.x** - ä¸»è¦åç«¯æ¡†æ¶
- **Django REST Framework** - API æ¡†æ¶
- **Celery** - å¼‚æ­¥ä»»åŠ¡å¤„ç†
- **kubernetes** - Python Kubernetes å®¢æˆ·ç«¯åº“
- **MySQL** - æ•°æ®åº“

### å‰ç«¯
- **React 18** - å‰ç«¯æ¡†æ¶
- **TypeScript** - ç±»å‹å®‰å…¨
- **Ant Design** - UI ç»„ä»¶åº“
- **Axios** - HTTP å®¢æˆ·ç«¯

## ğŸš€ éƒ¨ç½²å’Œè¿è¡Œ

### åç«¯å¯åŠ¨
```bash
cd backend/django_service
uv run python manage.py runserver 0.0.0.0:8000
```

### å‰ç«¯å¯åŠ¨
```bash
cd frontend
npm run dev
# è®¿é—®: http://localhost:5173/
```

### æµ‹è¯•é›†ç¾¤ç®¡ç†
1. è®¿é—®å‰ç«¯: http://localhost:5173/
2. å¯¼èˆªåˆ° Kubernetes ç®¡ç†é¡µé¢
3. ç‚¹å‡»"æ·»åŠ é›†ç¾¤"æµ‹è¯•é›†ç¾¤åˆ›å»ºæµç¨‹
4. ä½¿ç”¨æµ‹è¯•æ•°æ®éªŒè¯å„ç§è®¤è¯æ–¹å¼

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### ğŸ” å®‰å…¨ç‰¹æ€§
- âœ… å¤šç§ Kubernetes è®¤è¯æ–¹å¼æ”¯æŒ
- âœ… è¿æ¥é…ç½®å®‰å…¨å­˜å‚¨ï¼ˆJSON å­—æ®µåŠ å¯†ï¼‰
- âœ… ç”¨æˆ·æƒé™æ§åˆ¶
- âœ… è¾“å…¥éªŒè¯å’Œé”™è¯¯å¤„ç†

### âš¡ æ€§èƒ½ç‰¹æ€§
- âœ… å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼ˆé›†ç¾¤çŠ¶æ€æ£€æŸ¥ï¼‰
- âœ… æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- âœ… å‰ç«¯çŠ¶æ€ç®¡ç†
- âœ… æ‡’åŠ è½½å’Œåˆ†é¡µæ”¯æŒ

### ğŸ› ï¸ å¯ç»´æŠ¤æ€§
- âœ… æ¨¡å—åŒ–ä»£ç ç»“æ„
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… æ—¥å¿—è®°å½•é›†æˆ
- âœ… ç±»å‹å®‰å…¨ï¼ˆTypeScriptï¼‰

### ğŸ”„ å¯æ‰©å±•æ€§
- âœ… æ’ä»¶åŒ–çš„è®¤è¯æ–¹å¼
- âœ… èµ„æºç®¡ç†æ¡†æ¶
- âœ… ä»»åŠ¡ç³»ç»Ÿæ‰©å±•æ¥å£
- âœ… å‰ç«¯ç»„ä»¶å¤ç”¨

## ğŸ› å·²çŸ¥é—®é¢˜å’Œé™åˆ¶

1. **ç½‘ç»œè¿æ¥ä¾èµ–**
   - éœ€è¦èƒ½å¤Ÿè®¿é—® Kubernetes API æœåŠ¡å™¨
   - DNS è§£æéœ€è¦æ­£ç¡®é…ç½®

2. **æƒé™è¦æ±‚**
   - éœ€è¦é€‚å½“çš„ Kubernetes RBAC æƒé™
   - è¯ä¹¦å’Œ Token éœ€è¦æœ‰æ•ˆ

3. **æ¨¡æ‹Ÿæ¨¡å¼**
   - å½“ kubernetes åº“ä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§åˆ°æ¨¡æ‹Ÿæ¨¡å¼
   - æ¨¡æ‹Ÿæ•°æ®ä»…ç”¨äºå¼€å‘æµ‹è¯•

## ğŸ”® åç»­å¼€å‘å»ºè®®

### çŸ­æœŸä¼˜åŒ–
1. **å¢å¼ºé”™è¯¯å¤„ç†**
   - æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å±•ç¤º
   - è¿æ¥å¤±è´¥çš„å…·ä½“åŸå› åˆ†æ

2. **UI/UX æ”¹è¿›**
   - åŠ è½½çŠ¶æ€ä¼˜åŒ–
   - å“åº”å¼è®¾è®¡å®Œå–„

3. **åŠŸèƒ½å®Œå–„**
   - èµ„æºä½¿ç”¨ç›‘æ§
   - é›†ç¾¤å¥åº·æ£€æŸ¥ä»ªè¡¨æ¿

### é•¿æœŸè§„åˆ’
1. **é«˜çº§åŠŸèƒ½**
   - å¤šé›†ç¾¤ç®¡ç†
   - èµ„æºé…é¢ç®¡ç†
   - è‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®

2. **é›†æˆåŠŸèƒ½**
   - CI/CD æµæ°´çº¿é›†æˆ
   - ç›‘æ§å‘Šè­¦ç³»ç»Ÿ
   - æ—¥å¿—èšåˆåˆ†æ

## ğŸ“ˆ æ€»ç»“

æœ¬æ¬¡å¼€å‘æˆåŠŸå®ç°äº†å®Œæ•´çš„ Kubernetes é›†ç¾¤ç®¡ç†åŠŸèƒ½ï¼Œä»åŸæœ‰çš„æ¨¡æ‹Ÿæ•°æ®å‡çº§ä¸ºçœŸå®çš„ Kubernetes API é›†æˆã€‚ç³»ç»Ÿå…·å¤‡äº†ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„åŸºç¡€åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¤šç§è®¤è¯æ–¹å¼ã€è¿æ¥éªŒè¯ã€å¼‚æ­¥ä»»åŠ¡å¤„ç†ç­‰å…³é”®ç‰¹æ€§ã€‚

**ä¸»è¦æˆå°±ï¼š**
- âœ… å®Œæ•´çš„å…¨æ ˆå®ç°ï¼ˆå‰ç«¯ + åç«¯ï¼‰
- âœ… å¤šç§ Kubernetes è®¤è¯æ–¹å¼æ”¯æŒ
- âœ… å®æ—¶è¿æ¥éªŒè¯å’ŒçŠ¶æ€ç›‘æ§
- âœ… å¼‚æ­¥ä»»åŠ¡å¤„ç†æ¶æ„
- âœ… ç±»å‹å®‰å…¨å’Œé”™è¯¯å¤„ç†
- âœ… æµ‹è¯•å·¥å…·å’Œç¤ºä¾‹æ•°æ®

è¿™ä¸º AnsFlow é¡¹ç›®çš„ Kubernetes é›†æˆå¥ å®šäº†åšå®çš„åŸºç¡€ï¼Œå¯ä»¥æ”¯æŒåç»­çš„å®¹å™¨åŒ–éƒ¨ç½²å’Œè‡ªåŠ¨åŒ–è¿ç»´åŠŸèƒ½å¼€å‘ã€‚

---

**å¼€å‘æ—¶é—´ï¼š** 2025å¹´8æœˆ12æ—¥  
**çŠ¶æ€ï¼š** âœ… å®Œæˆ  
**ä¸‹ä¸€æ­¥ï¼š** å¯ä»¥å¼€å§‹é›†æˆåˆ°ä¸»è¦å·¥ä½œæµç¨‹ä¸­ï¼Œæˆ–ç»§ç»­å¼€å‘èµ„æºç®¡ç†åŠŸèƒ½
