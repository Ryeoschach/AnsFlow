# Docker/Kubernetes 流水线步骤使用指南

## 🎯 添加 Docker/K8s 步骤的具体位置

### 1. 访问流水线编辑器
- 在流水线管理页面中，点击需要编辑的流水线
- 或创建新的流水线
- 进入 **流水线编辑器** 界面

### 2. 添加步骤的操作路径
```
流水线编辑器页面 
   ↓
点击 "添加步骤" 按钮（蓝色按钮，带有 + 图标）
   ↓
弹出 "新建步骤" 抽屉面板
   ↓
在 "步骤类型" 下拉选择框中选择对应的 Docker/K8s 步骤类型
   ↓
配置步骤参数
   ↓
点击 "添加步骤" 完成
```

## 🐳 Docker 步骤类型详解

### 可选的 Docker 步骤类型：

#### 1. **Docker Build** - 构建 Docker 镜像
- **步骤类型**: `docker_build`
- **用途**: 从 Dockerfile 构建 Docker 镜像
- **主要参数**:
  - `dockerfile_path`: Dockerfile 路径
  - `image_name`: 镜像名称
  - `image_tag`: 镜像标签
  - `build_context`: 构建上下文路径
  - `build_args`: 构建参数

#### 2. **Docker Run** - 运行 Docker 容器
- **步骤类型**: `docker_run`
- **用途**: 运行 Docker 容器
- **主要参数**:
  - `image`: 镜像名称
  - `container_name`: 容器名称
  - `ports`: 端口映射
  - `volumes`: 卷挂载
  - `environment`: 环境变量

#### 3. **Docker Push** - 推送镜像到注册表
- **步骤类型**: `docker_push`
- **用途**: 将镜像推送到 Docker 注册表
- **主要参数**:
  - `image`: 镜像名称
  - `registry`: Docker 注册表信息
  - `username`: 用户名
  - `password`: 密码

#### 4. **Docker Pull** - 从注册表拉取镜像
- **步骤类型**: `docker_pull`
- **用途**: 从 Docker 注册表拉取镜像
- **主要参数**:
  - `image`: 镜像名称
  - `registry`: Docker 注册表信息

## ☸️ Kubernetes 步骤类型详解

### 可选的 Kubernetes 步骤类型：

#### 1. **Kubernetes Deploy** - 部署应用到 K8s 集群
- **步骤类型**: `k8s_deploy`
- **用途**: 部署应用到 Kubernetes 集群
- **主要参数**:
  - `manifest_file`: Kubernetes 清单文件
  - `namespace`: 命名空间
  - `cluster`: 集群配置
  - `image`: 容器镜像

#### 2. **Kubernetes Scale** - 扩缩容 K8s 部署
- **步骤类型**: `k8s_scale`
- **用途**: 调整 Deployment 的副本数
- **主要参数**:
  - `deployment_name`: Deployment 名称
  - `replicas`: 副本数
  - `namespace`: 命名空间

#### 3. **Kubernetes Delete** - 删除 K8s 资源
- **步骤类型**: `k8s_delete`
- **用途**: 删除 Kubernetes 资源
- **主要参数**:
  - `resource_type`: 资源类型
  - `resource_name`: 资源名称
  - `namespace`: 命名空间

#### 4. **Kubernetes Wait** - 等待 K8s 资源状态
- **步骤类型**: `k8s_wait`
- **用途**: 等待资源达到指定状态
- **主要参数**:
  - `resource_type`: 资源类型
  - `resource_name`: 资源名称
  - `condition`: 等待条件
  - `timeout`: 超时时间

#### 5. **Kubernetes Exec** - 在 Pod 中执行命令
- **步骤类型**: `k8s_exec`
- **用途**: 在指定 Pod 中执行命令
- **主要参数**:
  - `pod_name`: Pod 名称
  - `container`: 容器名称
  - `command`: 执行的命令
  - `namespace`: 命名空间

#### 6. **Kubernetes Logs** - 获取 Pod 日志
- **步骤类型**: `k8s_logs`
- **用途**: 获取 Pod 的日志
- **主要参数**:
  - `pod_name`: Pod 名称
  - `container`: 容器名称
  - `namespace`: 命名空间
  - `follow`: 是否跟踪日志

## 📱 前端界面操作详解

### 步骤添加界面布局

```
┌─────────────────────────────────────────────────────────┐
│                    流水线编辑器                            │
├─────────────────────────────────────────────────────────┤
│  [保存] [预览Pipeline] [添加步骤] [并行组管理] [更多...]    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  现有步骤列表：                                          │
│  1. 代码拉取                                            │
│  2. 构建                                               │
│  3. 测试                                               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 点击"添加步骤"后的表单界面

```
┌─────────────────────────────────────────────────────────┐
│                    新建步骤                               │
├─────────────────────────────────────────────────────────┤
│  步骤名称: [_________________]                           │
│                                                         │
│  步骤类型: [选择步骤类型 ▼]                              │
│    ├─ 代码拉取                                          │
│    ├─ 构建                                             │
│    ├─ 测试                                             │
│    ├─ 安全扫描                                          │
│    ├─ 部署                                             │
│    ├─ Ansible自动化                                     │
│    ├─ Docker Build      ← Docker 步骤                   │
│    ├─ Docker Run                                       │
│    ├─ Docker Push                                      │
│    ├─ Docker Pull                                      │
│    ├─ Kubernetes Deploy ← K8s 步骤                      │
│    ├─ Kubernetes Scale                                 │
│    ├─ Kubernetes Delete                                │
│    ├─ Kubernetes Wait                                  │
│    ├─ Kubernetes Exec                                  │
│    ├─ Kubernetes Logs                                  │
│    ├─ 手动审批                                          │
│    ├─ 条件分支                                          │
│    ├─ 通知                                             │
│    └─ 自定义                                           │
│                                                         │
│  步骤描述: [_________________]                           │
│                                                         │
│  执行顺序: [4]                                          │
│                                                         │
│  ─────────────── 参数配置 ───────────────                │
│                                                         │
│  [查看参数说明] [?]                                      │
│                                                         │
│  (根据选择的步骤类型显示对应的配置表单)                    │
│                                                         │
│  步骤参数: [JSON格式参数]                                │
│                                                         │
│  [关闭] [添加步骤]                                       │
└─────────────────────────────────────────────────────────┘
```

## 🔧 配置表单智能渲染

### Docker 步骤配置表单
当选择 Docker 相关步骤类型时，会自动显示 `DockerStepConfig` 组件：

- **Docker 注册表选择**
- **镜像配置**
- **容器配置**
- **网络配置**
- **存储配置**

### Kubernetes 步骤配置表单
当选择 Kubernetes 相关步骤类型时，会自动显示 `KubernetesStepConfig` 组件：

- **K8s 集群选择**
- **命名空间选择**
- **资源配置**
- **部署策略**
- **服务配置**

## 📝 参数文档支持

每个步骤类型都有详细的参数文档：

1. **点击"查看参数说明"按钮**
2. **展开参数文档面板**
3. **查看参数描述和示例**
4. **点击参数可自动填充到表单**

## 🎨 用户体验特性

### 1. 智能表单渲染
- 根据步骤类型自动显示对应的配置表单
- 隐藏不相关的配置项
- 提供智能默认值

### 2. 参数验证
- 实时验证必填参数
- 格式检查（JSON、YAML等）
- 依赖关系检查

### 3. 资源管理集成
- 一键跳转到资源管理页面
- 创建缺失的资源（注册表、集群等）
- 资源状态实时同步

### 4. 错误处理
- 友好的错误提示
- 参数验证失败提示
- 网络异常处理

## 🚀 典型使用场景

### 场景1：构建并推送 Docker 镜像
```
1. Docker Build (构建镜像)
   ↓
2. Docker Push (推送到注册表)
```

### 场景2：完整的容器化部署流程
```
1. 代码拉取
   ↓
2. Docker Build (构建镜像)
   ↓
3. Docker Push (推送镜像)
   ↓
4. Kubernetes Deploy (部署到K8s)
   ↓
5. Kubernetes Wait (等待部署完成)
```

### 场景3：蓝绿部署
```
1. Kubernetes Deploy (部署新版本)
   ↓
2. Kubernetes Wait (等待就绪)
   ↓
3. 手动审批 (确认切换)
   ↓
4. Kubernetes Scale (缩容旧版本)
   ↓
5. Kubernetes Delete (删除旧版本)
```

## ⚠️ 注意事项

1. **前置条件**：
   - 确保已配置 Docker 注册表
   - 确保已配置 Kubernetes 集群
   - 确保网络连接正常

2. **权限要求**：
   - Docker 操作需要相应的注册表权限
   - Kubernetes 操作需要集群访问权限

3. **参数格式**：
   - JSON 参数必须格式正确
   - 敏感信息建议使用凭据管理

4. **执行环境**：
   - 确保执行环境已安装 Docker
   - 确保执行环境已安装 kubectl
   - 确保执行环境网络可达目标资源

## 📞 技术支持

如有任何问题，请：
1. 查看参数文档
2. 检查系统日志
3. 联系技术支持团队

---

**总结**：Docker/K8s 步骤的添加位置就在流水线编辑器的"添加步骤"按钮中，通过步骤类型下拉框选择对应的 Docker 或 Kubernetes 步骤类型，系统会自动显示相应的配置表单，用户填写必要参数即可完成添加。
