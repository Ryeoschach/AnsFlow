# Kubernetes Token æ™ºèƒ½ç®¡ç†ä½¿ç”¨æŒ‡å—

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

AnsFlow çš„ Kubernetes Token æ™ºèƒ½ç®¡ç†ç³»ç»Ÿè§£å†³äº† Kubernetes é›†ç¾¤ Token è¿‡æœŸçš„å¸¸è§é—®é¢˜ï¼Œæä¾›å…¨é¢çš„ Token ç”Ÿå‘½å‘¨æœŸç®¡ç†è§£å†³æ–¹æ¡ˆã€‚

### âœ¨ ä¸»è¦åŠŸèƒ½

1. **æ™ºèƒ½ Token åˆ†æ** - è‡ªåŠ¨æ£€æµ‹ Token ç±»å‹ã€è¿‡æœŸæ—¶é—´å’Œæœ‰æ•ˆæ€§
2. **å®æ—¶è¿æ¥éªŒè¯** - ç¼“å­˜ä¼˜åŒ–çš„è¿æ¥çŠ¶æ€æ£€æŸ¥
3. **ä¸ªæ€§åŒ–æ›´æ–°å»ºè®®** - åŸºäºå½“å‰çŠ¶æ€çš„æ™ºèƒ½å»ºè®®ç³»ç»Ÿ
4. **å®Œæ•´æ›´æ–°æŒ‡å—** - è¯¦ç»†çš„æ­¥éª¤è¯´æ˜å’Œå‘½ä»¤ç¤ºä¾‹
5. **è‡ªåŠ¨åŒ–è„šæœ¬ç”Ÿæˆ** - æä¾›ç°æˆçš„è‡ªåŠ¨åŒ–æ›´æ–°è„šæœ¬

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è®¿é—® Token ç®¡ç†å™¨

åœ¨ **Kubernetes é›†ç¾¤ç®¡ç†** é¡µé¢ä¸­ï¼š

1. æ‰¾åˆ°éœ€è¦ç®¡ç† Token çš„é›†ç¾¤
2. ç‚¹å‡»æ“ä½œåˆ—ä¸­çš„ **ğŸ”§ Token ç®¡ç†** æŒ‰é’®
3. Token ç®¡ç†å™¨å°†è‡ªåŠ¨æ‰“å¼€å¹¶åˆ†æå½“å‰çŠ¶æ€

### 2. æŸ¥çœ‹ Token çŠ¶æ€

Token ç®¡ç†å™¨ä¼šæ˜¾ç¤ºï¼š

- **çŠ¶æ€æ¦‚è§ˆ** - Token çš„æ•´ä½“å¥åº·çŠ¶å†µ
- **è¿‡æœŸæ—¶é—´** - å‰©ä½™æœ‰æ•ˆæœŸå’Œä½¿ç”¨è¿›åº¦
- **è¿æ¥ä¿¡æ¯** - é›†ç¾¤ç‰ˆæœ¬ã€èŠ‚ç‚¹çŠ¶æ€ç­‰
- **æ™ºèƒ½å»ºè®®** - åŸºäºå½“å‰çŠ¶æ€çš„è¡ŒåŠ¨å»ºè®®

---

## ğŸ“Š çŠ¶æ€è§£è¯»

### Token çŠ¶æ€ç±»å‹

| çŠ¶æ€ | å›¾æ ‡ | å«ä¹‰ | å»ºè®®è¡ŒåŠ¨ |
|------|------|------|----------|
| âœ… **æœ‰æ•ˆ** | ğŸŸ¢ | Token å·¥ä½œæ­£å¸¸ | å®šæœŸæ£€æŸ¥å³å¯ |
| âš ï¸ **è­¦å‘Š** | ğŸŸ¡ | Token å³å°†è¿‡æœŸ | å‡†å¤‡æ›´æ–°è®¡åˆ’ |
| âŒ **æ— æ•ˆ** | ğŸ”´ | Token æ— æ³•è¿æ¥ | ç«‹å³æ›´æ–° Token |
| â„¹ï¸ **æœªé…ç½®** | ğŸ”µ | æœªè®¾ç½® Token | é…ç½®æ–° Token |

### çŠ¶æ€è¯¦æƒ…è¯´æ˜

#### ğŸŸ¢ Token æœ‰æ•ˆ
- **è¿‡æœŸæ—¶é—´**: æ˜¾ç¤ºå…·ä½“è¿‡æœŸæ—¥æœŸå’Œå‰©ä½™å¤©æ•°
- **è¿æ¥çŠ¶æ€**: æ˜¾ç¤ºé›†ç¾¤ç‰ˆæœ¬å’ŒèŠ‚ç‚¹ä¿¡æ¯
- **å»ºè®®**: è€ƒè™‘å®æ–½é•¿æœŸè®¤è¯ç­–ç•¥

#### ğŸŸ¡ Token è­¦å‘Š
- **å³å°†è¿‡æœŸ**: é€šå¸¸åœ¨ 24 å°æ—¶å†…è¿‡æœŸ
- **å»ºè®®**: æå‰å‡†å¤‡æ–° Tokenï¼Œé¿å…æœåŠ¡ä¸­æ–­
- **é¢„è­¦é˜ˆå€¼**: å¯åœ¨è®¾ç½®ä¸­è°ƒæ•´

#### ğŸ”´ Token æ— æ•ˆ
- **å¸¸è§åŸå› **:
  - Token å·²è¿‡æœŸ
  - Token æ ¼å¼é”™è¯¯
  - é›†ç¾¤è¿æ¥é—®é¢˜
  - æƒé™ä¸è¶³
- **ç«‹å³è¡ŒåŠ¨**: æŒ‰ç…§æ›´æ–°æŒ‡å—ç”Ÿæˆæ–° Token

---

## ğŸ› ï¸ Token æ›´æ–°æµç¨‹

### æ–¹æ³•ä¸€ï¼šå¿«é€Ÿæ›´æ–°ï¼ˆæ¨èï¼‰

1. **æ‰“å¼€æ›´æ–°æŒ‡å—**
   - åœ¨ Token ç®¡ç†å™¨ä¸­ç‚¹å‡» "æ›´æ–°æŒ‡å—"
   - æŒ‰ç…§æ­¥éª¤æ‰§è¡Œå‘½ä»¤

2. **ç”Ÿæˆæ–° Token**
   ```bash
   # åˆ›å»º Service Account
   kubectl create serviceaccount ansflow-sa -n default
   
   # ç»‘å®šæƒé™
   kubectl create clusterrolebinding ansflow-binding \
     --clusterrole=cluster-admin \
     --serviceaccount=default:ansflow-sa
   
   # ç”Ÿæˆ Tokenï¼ˆ1å¹´æœ‰æ•ˆæœŸï¼‰
   kubectl create token ansflow-sa --duration=8760h
   ```

3. **æ›´æ–° AnsFlow é…ç½®**
   - ç¼–è¾‘é›†ç¾¤é…ç½®
   - ç²˜è´´æ–° Token
   - æµ‹è¯•è¿æ¥
   - ä¿å­˜é…ç½®

### æ–¹æ³•äºŒï¼šæ°¸ä¹… Tokenï¼ˆé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰

1. **åˆ›å»º Secret**
   ```yaml
   apiVersion: v1
   kind: Secret
   metadata:
     name: ansflow-sa-token
     annotations:
       kubernetes.io/service-account.name: ansflow-sa
   type: kubernetes.io/service-account-token
   ```

2. **è·å– Token**
   ```bash
   kubectl get secret ansflow-sa-token -o jsonpath="{.data.token}" | base64 -d
   ```

3. **æ›´æ–°é…ç½®**
   - åœ¨ AnsFlow ä¸­æ›´æ–° Token
   - éªŒè¯è¿æ¥çŠ¶æ€

---

## ğŸ¤– è‡ªåŠ¨åŒ–è§£å†³æ–¹æ¡ˆ

### è‡ªåŠ¨åŒ–è„šæœ¬

Token ç®¡ç†å™¨æä¾›å®Œæ•´çš„è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œæ”¯æŒï¼š

- **å®šæœŸæ£€æŸ¥** Token çŠ¶æ€
- **è‡ªåŠ¨ç”Ÿæˆ** æ–° Token
- **API æ›´æ–°** AnsFlow é…ç½®
- **é”™è¯¯å¤„ç†** å’Œé‡è¯•æœºåˆ¶

### ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬

1. **ä¸‹è½½è„šæœ¬**
   - åœ¨ Token ç®¡ç†å™¨çš„ "è‡ªåŠ¨åŒ–é€‰é¡¹" æ ‡ç­¾é¡µ
   - å¤åˆ¶æä¾›çš„è„šæœ¬å†…å®¹

2. **é…ç½®ç¯å¢ƒå˜é‡**
   ```bash
   export ANSFLOW_API_URL="http://your-ansflow-instance/api"
   export CLUSTER_ID="your-cluster-id"
   export ANSFLOW_TOKEN="your-ansflow-api-token"
   ```

3. **è®¾ç½®å®šæ—¶ä»»åŠ¡**
   ```bash
   # ç¼–è¾‘ crontab
   crontab -e
   
   # æ·»åŠ æ¯æœˆæ‰§è¡Œçš„ä»»åŠ¡
   0 0 1 * * /path/to/token-update-script.sh --cron
   ```

---

## ğŸ”§ é«˜çº§é…ç½®

### è®¤è¯æ–¹å¼å¯¹æ¯”

| è®¤è¯æ–¹å¼ | æœ‰æ•ˆæœŸ | å®‰å…¨æ€§ | ç®¡ç†å¤æ‚åº¦ | æ¨èåœºæ™¯ |
|----------|--------|--------|------------|----------|
| **Token** | å¯é…ç½® | ä¸­ç­‰ | ç®€å• | å¼€å‘æµ‹è¯• |
| **Kubeconfig** | é•¿æœŸ | é«˜ | ä¸­ç­‰ | ç”Ÿäº§ç¯å¢ƒ |
| **è¯ä¹¦** | å¾ˆé•¿ | å¾ˆé«˜ | å¤æ‚ | ä¼ä¸šçº§ |

### åˆ‡æ¢è®¤è¯æ–¹å¼

#### ä» Token åˆ‡æ¢åˆ° Kubeconfig

1. **å¯¼å‡ºå½“å‰é…ç½®**
   ```bash
   kubectl config view --raw > kubeconfig.yaml
   ```

2. **åœ¨ AnsFlow ä¸­é…ç½®**
   - ç¼–è¾‘é›†ç¾¤
   - é€‰æ‹© "Kubeconfig è®¤è¯"
   - ä¸Šä¼ é…ç½®æ–‡ä»¶

3. **æµ‹è¯•æ–°é…ç½®**
   - éªŒè¯è¿æ¥çŠ¶æ€
   - ç¡®è®¤åŠŸèƒ½æ­£å¸¸

#### ä» Token åˆ‡æ¢åˆ°è¯ä¹¦è®¤è¯

1. **ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦**
   ```bash
   # ç”Ÿæˆç§é’¥
   openssl genrsa -out client.key 2048
   
   # ç”Ÿæˆè¯ä¹¦è¯·æ±‚
   openssl req -new -key client.key -out client.csr
   
   # ä½¿ç”¨ CA ç­¾å
   openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -out client.crt
   ```

2. **é…ç½® AnsFlow**
   - é€‰æ‹© "è¯ä¹¦è®¤è¯"
   - ä¸Šä¼ å®¢æˆ·ç«¯è¯ä¹¦å’Œç§é’¥
   - é…ç½® CA è¯ä¹¦

---

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. Token ç”Ÿæˆå¤±è´¥

**é—®é¢˜**: `kubectl create token` å‘½ä»¤å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ Service Account æ˜¯å¦å­˜åœ¨
kubectl get serviceaccount ansflow-sa

# æ£€æŸ¥æƒé™ç»‘å®š
kubectl get clusterrolebinding ansflow-binding

# é‡æ–°åˆ›å»º Service Account
kubectl delete serviceaccount ansflow-sa
kubectl create serviceaccount ansflow-sa
```

#### 2. è¿æ¥æµ‹è¯•å¤±è´¥

**é—®é¢˜**: Token æ›´æ–°åè¿æ¥ä»ç„¶å¤±è´¥

**å¯èƒ½åŸå› **:
- API Server åœ°å€é”™è¯¯
- ç½‘ç»œè¿é€šæ€§é—®é¢˜
- è¯ä¹¦éªŒè¯å¤±è´¥
- æƒé™ä¸è¶³

**æ’æŸ¥æ­¥éª¤**:
```bash
# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
curl -k https://your-k8s-api:6443/version

# éªŒè¯ Token æƒé™
kubectl auth can-i "*" "*" --token="your-token"

# æ£€æŸ¥è¯ä¹¦
openssl s_client -connect your-k8s-api:6443 -servername kubernetes
```

#### 3. æƒé™ä¸è¶³

**é—®é¢˜**: Token æœ‰æ•ˆä½†æ“ä½œå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥å½“å‰æƒé™
kubectl auth can-i --list --token="your-token"

# é‡æ–°ç»‘å®šç®¡ç†å‘˜æƒé™
kubectl create clusterrolebinding ansflow-admin \
  --clusterrole=cluster-admin \
  --serviceaccount=default:ansflow-sa
```

#### 4. Token æ ¼å¼é”™è¯¯

**é—®é¢˜**: Token æ— æ³•è§£æ

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿ Token å®Œæ•´å¤åˆ¶ï¼Œæ²¡æœ‰å¤šä½™ç©ºæ ¼
- æ£€æŸ¥ Token æ˜¯å¦æ˜¯ Base64 ç¼–ç 
- éªŒè¯ Token æ ¼å¼æ˜¯å¦æ­£ç¡®

---

## ğŸ“ˆ æœ€ä½³å®è·µ

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **ä½¿ç”¨é•¿æœŸæœ‰æ•ˆçš„ Token**
   - åˆ›å»º Secret æ–¹å¼çš„æ°¸ä¹… Token
   - æˆ–ä½¿ç”¨ Kubeconfig/è¯ä¹¦è®¤è¯

2. **å®æ–½ç›‘æ§æœºåˆ¶**
   - è®¾ç½®å®šæœŸæ£€æŸ¥
   - é…ç½®è¿‡æœŸæé†’
   - å®ç°è‡ªåŠ¨åŒ–æ›´æ–°

3. **éµå¾ªæœ€å°æƒé™åŸåˆ™**
   - ä¸è¦ä½¿ç”¨ cluster-admin æƒé™
   - åˆ›å»ºä¸“ç”¨çš„ Role å’Œ RoleBinding
   - å®šæœŸå®¡è®¡æƒé™

4. **å¤‡ä»½è®¤è¯ä¿¡æ¯**
   - ä¿å­˜å¤šä¸ªæœ‰æ•ˆ Token
   - å¤‡ä»½ Kubeconfig æ–‡ä»¶
   - å‡†å¤‡åº”æ€¥æ¢å¤æ–¹æ¡ˆ

### å®‰å…¨è€ƒè™‘

1. **Token å­˜å‚¨å®‰å…¨**
   - ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç  Token
   - ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡
   - å®šæœŸè½®æ¢ Token

2. **ç½‘ç»œå®‰å…¨**
   - ä½¿ç”¨ HTTPS è¿æ¥
   - éªŒè¯ CA è¯ä¹¦
   - é™åˆ¶ç½‘ç»œè®¿é—®

3. **å®¡è®¡æ—¥å¿—**
   - è®°å½•æ‰€æœ‰ Token ä½¿ç”¨
   - ç›‘æ§å¼‚å¸¸è®¿é—®
   - å®šæœŸå®¡æŸ¥æƒé™

---

## ğŸ†˜ æŠ€æœ¯æ”¯æŒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**
   - æ£€æŸ¥ AnsFlow æœåŠ¡æ—¥å¿—
   - æŸ¥çœ‹ Kubernetes å®¡è®¡æ—¥å¿—
   - åˆ†æç½‘ç»œè¿æ¥æ—¥å¿—

2. **ä½¿ç”¨è¯Šæ–­å·¥å…·**
   - Token ç®¡ç†å™¨çš„çŠ¶æ€åˆ†æ
   - è¿æ¥æµ‹è¯•åŠŸèƒ½
   - é”™è¯¯ä¿¡æ¯æç¤º

3. **è”ç³»æ”¯æŒ**
   - æŠ€æœ¯æ”¯æŒ: support@ansflow.com
   - å¼€å‘å›¢é˜Ÿ: dev@ansflow.com
   - ç¤¾åŒºè®ºå›: [GitHub Issues](https://github.com/ansflow/ansflow/issues)

---

## ğŸ”„ ç‰ˆæœ¬æ›´æ–°

### v1.0 åŠŸèƒ½ç‰¹æ€§
- âœ… åŸºç¡€ Token åˆ†æå’ŒéªŒè¯
- âœ… æ™ºèƒ½æ›´æ–°å»ºè®®
- âœ… å®Œæ•´æ›´æ–°æŒ‡å—
- âœ… è‡ªåŠ¨åŒ–è„šæœ¬ç”Ÿæˆ

### æœªæ¥è§„åˆ’
- ğŸš§ å¤šé›†ç¾¤ Token æ‰¹é‡ç®¡ç†
- ğŸš§ Token è¿‡æœŸé‚®ä»¶æé†’
- ğŸš§ ä¸ CI/CD ç³»ç»Ÿé›†æˆ
- ğŸš§ é«˜çº§æƒé™ç®¡ç†

---

**æœ€åæ›´æ–°**: 2025å¹´8æœˆ12æ—¥  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ç»´æŠ¤å›¢é˜Ÿ**: AnsFlow å¼€å‘å›¢é˜Ÿ
