# æ­¥éª¤æ‰§è¡Œå™¨æ¨¡æ‹Ÿæ•°æ®æ¸…ç†æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šæµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼ŒDockeræ„å»ºæ­¥éª¤å‡ºç° "no such file or directory" é”™è¯¯ã€‚é€šè¿‡åˆ†æå‘ç°ï¼Œé—®é¢˜æ ¹æºåœ¨äºæ­¥éª¤æ‰§è¡Œå™¨ä¸­å­˜åœ¨å¤§é‡çš„æ¨¡æ‹Ÿ/Mockæ•°æ®å’Œé€»è¾‘ï¼Œå¯¼è‡´ï¼š

1. **ä»£ç æ£€å‡ºæ­¥éª¤**ï¼šåˆ›å»ºæ¨¡æ‹Ÿçš„é¡¹ç›®æ–‡ä»¶è€ŒéçœŸå®çš„ä»£ç æ‹‰å–
2. **Dockeræ„å»ºæ­¥éª¤**ï¼šå°è¯•æ„å»ºçœŸå®Dockeré•œåƒï¼Œä½†å·¥ä½œç›®å½•ä¸­ç¼ºå°‘å¿…è¦çš„Dockerfile
3. **é€šçŸ¥æ­¥éª¤**ï¼šæ‰§è¡Œæ¨¡æ‹Ÿé€šçŸ¥è€ŒéçœŸå®çš„é€šçŸ¥å‘½ä»¤
4. **å…¶ä»–æ­¥éª¤**ï¼šå›é€€åˆ°å®Œå…¨çš„æ¨¡æ‹Ÿæ‰§è¡Œ

## ä¿®å¤å†…å®¹

### 1. ä»£ç æ£€å‡ºæ­¥éª¤ä¼˜åŒ– (`_execute_fetch_code`)

#### ä¿®å¤å‰ï¼š
```python
# åˆ›å»ºæ¨¡æ‹Ÿçš„é¡¹ç›®ç»“æ„å’Œæ–‡ä»¶
commands = [
    f'cd {target_dir} && echo "æ¨¡æ‹Ÿä»£ç æ‹‰å–å®Œæˆï¼Œåˆ†æ”¯: {branch}" > README.md',
    f'cd {target_dir} && echo "è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„é¡¹ç›®ä»“åº“ï¼Œç”¨äºCI/CDæµæ°´çº¿æµ‹è¯•ã€‚" >> README.md',
    # åˆ›å»ºæ¨¡æ‹Ÿçš„Dockerfileã€package.jsonç­‰æ–‡ä»¶
]
```

#### ä¿®å¤åï¼š
```python
# çœŸå®çš„ä»£ç æ‹‰å–å‘½ä»¤
if not repository_url:
    return {
        'success': False,
        'error_message': 'ä»£ç ä»“åº“URLæœªé…ç½®ï¼Œè¯·åœ¨æ­¥éª¤é…ç½®ä¸­æŒ‡å®šrepository_url',
        'output': ''
    }

commands = [
    f'mkdir -p {target_dir}',
    f'cd {target_dir} && git clone {repository_url} .',
    f'cd {target_dir} && git checkout {branch}'
]
```

### 2. Dockeræ„å»ºæ­¥éª¤ä¼˜åŒ– (`_execute_docker_fallback`)

#### ä¿®å¤å‰ï¼š
```python
# åˆ›å»ºæ¨¡æ‹Ÿçš„Dockerfile
dockerfile_content = f"""FROM {docker_image}
LABEL description="æ¨¡æ‹Ÿæ„å»ºçš„Dockeré•œåƒ"
..."""

commands = [
    f"echo 'ğŸ’¾ æ¨¡æ‹Ÿæ„å»ºæˆåŠŸï¼Œæœªå®é™…æ‰§è¡Œdocker buildå‘½ä»¤'"
]
```

#### ä¿®å¤åï¼š
```python
# æ£€æŸ¥çœŸå®çš„Dockerfileæ˜¯å¦å­˜åœ¨
dockerfile_path = os.path.join(build_context, 'Dockerfile')
if not os.path.exists(dockerfile_path):
    return {
        'success': False,
        'error_message': f'Dockerfileä¸å­˜åœ¨äºè·¯å¾„: {dockerfile_path}ï¼Œè¯·ç¡®ä¿ä»£ç æ£€å‡ºæ­¥éª¤åŒ…å«Dockerfileæ–‡ä»¶',
        'output': f'æ£€æŸ¥è·¯å¾„: {dockerfile_path}'
    }

commands = [
    f"docker build -t {full_image} .",
    f"echo 'âœ… Dockeré•œåƒæ„å»ºå®Œæˆ: {full_image}'"
]
```

### 3. é€šçŸ¥æ­¥éª¤ä¼˜åŒ– (`_execute_notify`)

#### ä¿®å¤å‰ï¼š
```python
# æ¨¡æ‹Ÿé€šçŸ¥å‘é€
output = f"å‘é€{notify_type}é€šçŸ¥: {message}"
return {
    'success': True,
    'output': output,
    'metadata': {
        'message': message,
        'notify_type': notify_type
    }
}
```

#### ä¿®å¤åï¼š
```python
notify_command = config.get('notify_command')

if notify_command:
    # æ‰§è¡ŒçœŸå®çš„é€šçŸ¥å‘½ä»¤
    result = self._run_command(notify_command, execution_env)
    return result
else:
    # å¦‚æœæ²¡æœ‰é…ç½®é€šçŸ¥å‘½ä»¤ï¼Œè¿”å›é”™è¯¯
    return {
        'success': False,
        'error_message': 'é€šçŸ¥æ­¥éª¤æœªé…ç½®notify_commandï¼Œè¯·æŒ‡å®šå…·ä½“çš„é€šçŸ¥å‘½ä»¤',
        'output': f'é€šçŸ¥ç±»å‹: {notify_type}, æ¶ˆæ¯: {message}'
    }
```

### 4. ç§»é™¤æ¨¡æ‹Ÿæ‰§è¡Œæ–¹æ³•

å®Œå…¨åˆ é™¤äº† `_execute_mock` æ–¹æ³•ï¼Œå°†ä¸æ”¯æŒçš„æ­¥éª¤ç±»å‹æ”¹ä¸ºè¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯ï¼š

```python
# ä¿®å¤å‰
else:
    return self._execute_mock(step_obj, execution_env)

# ä¿®å¤å
else:
    return {
        'success': False,
        'error_message': f'ä¸æ”¯æŒçš„æ­¥éª¤ç±»å‹: {step_type}',
        'output': f'è¯·æ£€æŸ¥æ­¥éª¤é…ç½®ï¼Œå½“å‰æ­¥éª¤ç±»å‹ "{step_type}" å°šæœªå®ç°'
    }
```

### 5. é…ç½®é»˜è®¤å€¼æ¸…ç†

ç§»é™¤äº†ä»£ç æ£€å‡ºæ­¥éª¤çš„é»˜è®¤ç¤ºä¾‹ä»“åº“URLï¼š

```python
# ä¿®å¤å‰
config.setdefault('repository_url', 'https://github.com/example/repo.git')

# ä¿®å¤å
if not config.get('repository_url'):
    logger.warning("ä»£ç æ‹‰å–æ­¥éª¤ç¼ºå°‘repository_urlé…ç½®")
```

## æµ‹è¯•éªŒè¯

åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•è„šæœ¬ `test_real_step_execution.py`ï¼ŒéªŒè¯ä»¥ä¸‹åœºæ™¯ï¼š

1. **ä»£ç æ£€å‡ºæ­¥éª¤ç¼ºå°‘ä»“åº“URL** âœ…
   - é”™è¯¯ä¿¡æ¯ï¼š`ä»£ç ä»“åº“URLæœªé…ç½®ï¼Œè¯·åœ¨æ­¥éª¤é…ç½®ä¸­æŒ‡å®šrepository_url`

2. **Dockeræ„å»ºæ­¥éª¤ç¼ºå°‘Dockerfile** âœ…
   - é”™è¯¯ä¿¡æ¯ï¼š`Dockerfileä¸å­˜åœ¨äºè·¯å¾„: /tmp/xxx/Dockerfileï¼Œè¯·ç¡®ä¿ä»£ç æ£€å‡ºæ­¥éª¤åŒ…å«Dockerfileæ–‡ä»¶`

3. **é€šçŸ¥æ­¥éª¤ç¼ºå°‘é€šçŸ¥å‘½ä»¤** âœ…
   - é”™è¯¯ä¿¡æ¯ï¼š`é€šçŸ¥æ­¥éª¤æœªé…ç½®notify_commandï¼Œè¯·æŒ‡å®šå…·ä½“çš„é€šçŸ¥å‘½ä»¤`

4. **ä¸æ”¯æŒçš„æ­¥éª¤ç±»å‹** âœ…
   - é”™è¯¯ä¿¡æ¯ï¼š`ä¸æ”¯æŒçš„æ­¥éª¤ç±»å‹: unsupported_type`

## å½±å“åˆ†æ

### æ­£é¢å½±å“

1. **çœŸå®æ‰§è¡Œ**ï¼šæ­¥éª¤ç°åœ¨æ‰§è¡ŒçœŸå®çš„å‘½ä»¤ï¼Œè€Œéæ¨¡æ‹Ÿæ“ä½œ
2. **æ˜ç¡®é”™è¯¯**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£é…ç½®é—®é¢˜
3. **è°ƒè¯•å‹å¥½**ï¼šå¤±è´¥åŸå› æ˜ç¡®ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
4. **ç”Ÿäº§å°±ç»ª**ï¼šç§»é™¤äº†æµ‹è¯•/å¼€å‘é˜¶æ®µçš„æ¨¡æ‹Ÿé€»è¾‘

### éœ€è¦æ³¨æ„çš„å˜åŒ–

1. **é…ç½®è¦æ±‚**ï¼šç°åœ¨å¿…é¡»æä¾›çœŸå®çš„é…ç½®å‚æ•°
   - ä»£ç æ£€å‡ºæ­¥éª¤éœ€è¦ `repository_url`
   - é€šçŸ¥æ­¥éª¤éœ€è¦ `notify_command`
   - Dockeræ­¥éª¤éœ€è¦çœŸå®çš„Dockerfileæ–‡ä»¶

2. **æ‰§è¡Œç¯å¢ƒ**ï¼šéœ€è¦ç¡®ä¿æ‰§è¡Œç¯å¢ƒæœ‰ç›¸åº”çš„å·¥å…·
   - Gitï¼ˆç”¨äºä»£ç æ£€å‡ºï¼‰
   - Dockerï¼ˆç”¨äºå®¹å™¨æ“ä½œï¼‰
   - é€šçŸ¥å·¥å…·ï¼ˆå¦‚é‚®ä»¶å®¢æˆ·ç«¯ç­‰ï¼‰

## åç»­å»ºè®®

1. **å®Œå–„æ–‡æ¡£**ï¼šæ›´æ–°æµæ°´çº¿é…ç½®æ–‡æ¡£ï¼Œè¯´æ˜æ¯ä¸ªæ­¥éª¤ç±»å‹çš„å¿…éœ€å‚æ•°
2. **å‰ç«¯éªŒè¯**ï¼šåœ¨å‰ç«¯ç•Œé¢æ·»åŠ é…ç½®éªŒè¯ï¼Œç¡®ä¿å¿…éœ€å‚æ•°ä¸ä¸ºç©º
3. **é”™è¯¯æ¢å¤**ï¼šè€ƒè™‘æ·»åŠ é‡è¯•æœºåˆ¶å’Œæ›´è¯¦ç»†çš„é”™è¯¯æ¢å¤å»ºè®®
4. **å·¥å…·æ£€æŸ¥**ï¼šåœ¨æ­¥éª¤æ‰§è¡Œå‰æ£€æŸ¥æ‰€éœ€å·¥å…·çš„å¯ç”¨æ€§

## æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œæ­¥éª¤æ‰§è¡Œå™¨ä»"æ¼”ç¤ºæ¨¡å¼"è½¬å˜ä¸º"ç”Ÿäº§æ¨¡å¼"ï¼Œèƒ½å¤Ÿæ‰§è¡ŒçœŸå®çš„CI/CDæ“ä½œã€‚è™½ç„¶å¯¹é…ç½®è¦æ±‚æ›´åŠ ä¸¥æ ¼ï¼Œä½†è¿™ç¡®ä¿äº†æµæ°´çº¿çš„çœŸå®æ€§å’Œå¯é æ€§ã€‚

ç”¨æˆ·ä¹‹å‰é‡åˆ°çš„Dockeræ„å»ºå¤±è´¥é—®é¢˜ç°åœ¨ä¼šå¾—åˆ°æ˜ç¡®çš„é”™è¯¯æç¤ºï¼ŒæŒ‡å¯¼ç”¨æˆ·æ­£ç¡®é…ç½®ä»£ç ä»“åº“å’ŒDockerfileæ–‡ä»¶ã€‚
