# 本地执行器实施检查清单

## 部署前检查

### 1. 数据库迁移
- [ ] 确认迁移文件已生成：`0010_stepexecution_pipeline_step_alter_cicdtool_tool_type_and_more.py`
- [ ] 在生产环境运行迁移：`python manage.py migrate`
- [ ] 验证数据库结构：检查 `StepExecution` 表的 `pipeline_step_id` 字段

### 2. 本地执行器配置
- [ ] 在生产环境运行：`python manage.py setup_local_executor`
- [ ] 验证本地执行器创建成功：检查 `CICDTool` 表中是否有 `tool_type='local'` 的记录
- [ ] 确认本地执行器状态为 `'authenticated'`

### 3. 代码部署
- [ ] 前端代码部署：包含更新的 TypeScript 类型定义
- [ ] 后端代码部署：包含所有模型、序列化器和执行器更新
- [ ] 静态文件收集：`python manage.py collectstatic`

## 功能验证

### 1. 本地执行器功能
- [ ] 创建新流水线时可以选择本地执行器
- [ ] 本地执行器在 CI/CD 工具列表中显示为已认证状态
- [ ] 流水线可以成功使用本地执行器执行

### 2. 流水线编辑功能
- [ ] 编辑流水线基本信息（名称、描述等）不会删除已配置的步骤
- [ ] 拖拽式配置步骤可以正常保存和更新
- [ ] 页面风格创建的步骤可以正常保存

### 3. 步骤执行功能
- [ ] 页面风格创建的步骤可以正常执行
- [ ] 拖拽式配置的步骤可以正常执行
- [ ] 执行日志显示实际的命令和输出
- [ ] 错误处理和异常恢复正常工作

## 性能验证

### 1. 执行性能
- [ ] 测试大型流水线的执行性能
- [ ] 验证并发执行的稳定性
- [ ] 检查内存使用情况

### 2. 数据库性能
- [ ] 验证新的外键关系不会影响查询性能
- [ ] 检查执行日志的存储和检索速度
- [ ] 优化必要的数据库索引

## 安全检查

### 1. 权限控制
- [ ] 验证本地执行器的权限设置
- [ ] 确认只有授权用户可以创建和使用本地执行器
- [ ] 检查步骤执行的权限控制

### 2. 命令执行安全
- [ ] 确认命令执行在受限环境中进行
- [ ] 验证日志记录不会泄露敏感信息
- [ ] 检查错误处理不会暴露系统信息

## 回滚计划

### 1. 数据库回滚
```sql
-- 如果需要回滚数据库迁移
-- 注意：这会删除所有pipeline_step相关的执行记录
DELETE FROM cicd_integrations_stepexecution WHERE pipeline_step_id IS NOT NULL;
ALTER TABLE cicd_integrations_stepexecution DROP COLUMN pipeline_step_id;
UPDATE cicd_integrations_cicdtool SET tool_type = 'custom' WHERE tool_type = 'local';
```

### 2. 代码回滚
- [ ] 保留之前版本的代码分支
- [ ] 准备快速回滚脚本
- [ ] 确认回滚后的兼容性

## 监控设置

### 1. 日志监控
- [ ] 设置执行日志的监控报警
- [ ] 配置错误日志的收集和分析
- [ ] 监控执行性能指标

### 2. 业务监控
- [ ] 监控本地执行器的使用情况
- [ ] 跟踪流水线执行成功率
- [ ] 分析用户使用模式

## 用户通知

### 1. 功能发布
- [ ] 更新用户文档说明新功能
- [ ] 发布功能更新公告
- [ ] 提供使用指南和最佳实践

### 2. 用户支持
- [ ] 准备常见问题解答
- [ ] 培训客户支持团队
- [ ] 建立用户反馈收集机制

## 测试脚本运行

### 1. 自动化测试
```bash
# 本地执行器基础测试
cd tests/scripts/local-executor
python test_local_executor.py

# 前端验证测试
python test_frontend_validation.py

# 流水线保存修复测试
cd ../debug/pipeline-save-fix
python test_pipeline_step_fix.py
```

### 2. 手动测试
- [ ] 创建测试流水线
- [ ] 配置不同类型的步骤
- [ ] 验证执行和日志记录
- [ ] 测试编辑功能

## 完成签名

### 开发团队
- [ ] 开发人员确认：_________________
- [ ] 测试人员确认：_________________
- [ ] 产品经理确认：_________________

### 运维团队
- [ ] 系统管理员确认：_______________
- [ ] 数据库管理员确认：_____________
- [ ] 安全审计确认：_________________

### 最终审批
- [ ] 技术负责人签字：_______________
- [ ] 项目经理签字：_________________
- [ ] 发布批准：_____________________

---

**检查清单版本**: v1.0  
**创建日期**: 2025年7月15日  
**适用版本**: AnsFlow v1.0.0  
**状态**: 待检查 ⏳
