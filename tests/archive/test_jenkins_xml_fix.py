#!/usr/bin/env python3
"""
æµ‹è¯•XMLè½¬ä¹‰ä¿®å¤åçš„Jenkinsé›†æˆ
"""
import os
import sys
import asyncio
import django
import json
from datetime import datetime

# è®¾ç½®Djangoç¯å¢ƒ
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'django_service.settings')
sys.path.append('/Users/creed/workspace/sourceCode/AnsFlow/backend/django_service')

django.setup()

from cicd_integrations.adapters.jenkins import JenkinsAdapter
from cicd_integrations.adapters.base import PipelineDefinition


async def test_xml_escaping_fix():
    """æµ‹è¯•XMLè½¬ä¹‰ä¿®å¤"""
    print("=== æµ‹è¯•XMLè½¬ä¹‰ä¿®å¤ ===")
    
    # Jenkinsé…ç½®
    jenkins_config = {
        'base_url': 'http://localhost:8080',
        'username': 'admin',
        'token': 'admin'
    }
    
    # åˆ›å»ºé€‚é…å™¨
    adapter = JenkinsAdapter(**jenkins_config)
    
    # æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æµæ°´çº¿å®šä¹‰
    pipeline_def = PipelineDefinition(
        name="Test Special Characters Pipeline",
        steps=[
            {
                'id': 'step-1',
                'name': 'Code & Test',
                'type': 'fetch_code',
                'parameters': {
                    'repository': 'https://github.com/test/repo.git',
                    'branch': 'main',
                    'command': 'git clone "repo" && echo "Success!"'
                }
            },
            {
                'id': 'step-2', 
                'name': 'Ansible Deploy',
                'type': 'ansible',
                'parameters': {
                    'playbook_path': 'deploy.yml',
                    'inventory_path': 'hosts',
                    'extra_vars': {
                        'env': 'prod',
                        'database_url': 'postgresql://user:pass@host:5432/db'
                    },
                    'tags': 'deploy,config',
                    'verbose': True
                }
            },
            {
                'id': 'step-3',
                'name': 'Custom Script',
                'type': 'custom', 
                'parameters': {
                    'command': 'echo "Test <>&\'" && curl -X POST -d \'{"key": "value"}\' http://api.test.com'
                }
            }
        ],
        environment={
            'NODE_ENV': 'production',
            'API_URL': 'https://api.example.com/v1',
            'DATABASE_URL': 'postgresql://user:pass@host:5432/db'
        },
        timeout=3600
    )
    
    print(f"æµæ°´çº¿åç§°: {pipeline_def.name}")
    print(f"æ­¥éª¤æ•°é‡: {len(pipeline_def.steps)}")
    print()
    
    try:
        # 1. ç”ŸæˆJenkinsfileå†…å®¹
        print("1. ç”ŸæˆJenkinsfileå†…å®¹...")
        jenkinsfile = await adapter.create_pipeline_file(pipeline_def)
        print("âœ… Jenkinsfileç”ŸæˆæˆåŠŸ")
        print("Jenkinsfileå†…å®¹ï¼ˆå‰500å­—ç¬¦ï¼‰:")
        print(jenkinsfile[:500] + "..." if len(jenkinsfile) > 500 else jenkinsfile)
        print()
        
        # 2. æµ‹è¯•XMLè½¬ä¹‰
        print("2. æµ‹è¯•XMLè½¬ä¹‰...")
        import html
        escaped_jenkinsfile = html.escape(jenkinsfile)
        print("âœ… XMLè½¬ä¹‰æˆåŠŸ")
        print("è½¬ä¹‰åå†…å®¹ï¼ˆå‰200å­—ç¬¦ï¼‰:")
        print(escaped_jenkinsfile[:200] + "..." if len(escaped_jenkinsfile) > 200 else escaped_jenkinsfile)
        print()
        
        # 3. ç”Ÿæˆå®Œæ•´Job XML
        print("3. ç”ŸæˆJob XMLé…ç½®...")
        import re
        job_name = pipeline_def.name.replace(' ', '-').lower()
        job_name = re.sub(r'[^a-z0-9\-_]', '', job_name)
        
        job_config = f"""<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.40">
  <actions/>
  <description>Generated by AnsFlow CI/CD Platform</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
      <triggers/>
    </org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.92">
    <script>{escaped_jenkinsfile}</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>"""
        
        # 4. éªŒè¯XMLæ ¼å¼
        print("4. éªŒè¯XMLæ ¼å¼...")
        import xml.etree.ElementTree as ET
        try:
            ET.fromstring(job_config)
            print("âœ… XMLæ ¼å¼éªŒè¯é€šè¿‡")
        except ET.ParseError as e:
            print(f"âŒ XMLæ ¼å¼éªŒè¯å¤±è´¥: {e}")
            return False
        
        # 5. ä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶ç”¨äºè°ƒè¯•
        print("5. ä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶...")
        with open('test_jenkinsfile.groovy', 'w', encoding='utf-8') as f:
            f.write(jenkinsfile)
        print("âœ… Jenkinsfileå·²ä¿å­˜åˆ° test_jenkinsfile.groovy")
        
        with open('test_job_config.xml', 'w', encoding='utf-8') as f:
            f.write(job_config)
        print("âœ… Jobé…ç½®å·²ä¿å­˜åˆ° test_job_config.xml")
        
        # 6. å°è¯•åˆ›å»ºJenkins Jobï¼ˆå¦‚æœJenkinsæœåŠ¡å¯ç”¨ï¼‰
        print("6. å°è¯•åˆ›å»ºJenkins Job...")
        try:
            # æ£€æŸ¥Jenkinsè¿æ¥
            async with adapter.client:
                response = await adapter.client.get(f"{adapter.base_url}/api/json", auth=adapter.auth)
                if response.status_code == 200:
                    print("âœ… Jenkinsè¿æ¥æ­£å¸¸")
                    
                    # å°è¯•åˆ›å»ºJob
                    job_name = await adapter.create_pipeline(pipeline_def)
                    print(f"âœ… Jenkins Jobåˆ›å»ºæˆåŠŸ: {job_name}")
                    return True
                else:
                    print(f"âš ï¸  Jenkinsè¿æ¥å¤±è´¥: {response.status_code}")
                    print("XMLè½¬ä¹‰ä¿®å¤å®Œæˆï¼Œä½†æ— æ³•æµ‹è¯•Jenkinsåˆ›å»º")
                    return True
        except Exception as e:
            print(f"âš ï¸  Jenkinsæµ‹è¯•å¤±è´¥: {e}")
            print("XMLè½¬ä¹‰ä¿®å¤å®Œæˆï¼Œä½†æ— æ³•è¿æ¥åˆ°Jenkins")
            return True
            
    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False


async def test_integration_pipeline_fix():
    """æµ‹è¯•Integration Test Pipelineçš„ä¿®å¤"""
    print("\n=== æµ‹è¯•Integration Test Pipelineä¿®å¤ ===")
    
    # å¯¼å…¥å¿…è¦çš„æ¨¡å‹
    from pipelines.models import Pipeline, AtomicStep
    
    try:
        # è·å–Integration Test Pipeline
        pipeline = Pipeline.objects.get(name="Integration Test Pipeline")
        print(f"æ‰¾åˆ°æµæ°´çº¿: {pipeline.name}")
        
        # è·å–æ‰€æœ‰æ­¥éª¤
        steps = AtomicStep.objects.filter(pipeline=pipeline).order_by('order')
        print(f"æ­¥éª¤æ•°é‡: {steps.count()}")
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«ansibleæ­¥éª¤
        ansible_steps = steps.filter(step_type='ansible')
        print(f"Ansibleæ­¥éª¤æ•°é‡: {ansible_steps.count()}")
        
        if ansible_steps.exists():
            print("âœ… åŒ…å«Ansibleæ­¥éª¤")
            for step in ansible_steps:
                print(f"  - {step.name} (order: {step.order})")
        else:
            print("âŒ ç¼ºå°‘Ansibleæ­¥éª¤")
            return False
        
        # åˆ›å»ºæµæ°´çº¿å®šä¹‰
        pipeline_steps = []
        for step in steps:
            pipeline_steps.append({
                'id': f'step-{step.order}',
                'name': step.name,
                'type': step.step_type,
                'parameters': step.parameters or {}
            })
        
        pipeline_def = PipelineDefinition(
            name=pipeline.name,
            steps=pipeline_steps,
            environment={},
            timeout=3600
        )
        
        # æµ‹è¯•Jenkinsé€‚é…å™¨
        jenkins_config = {
            'base_url': 'http://localhost:8080',
            'username': 'admin', 
            'token': 'admin'
        }
        
        adapter = JenkinsAdapter(**jenkins_config)
        
        # ç”ŸæˆJenkinsfile
        print("ç”ŸæˆJenkinsfile...")
        jenkinsfile = await adapter.create_pipeline_file(pipeline_def)
        print("âœ… Jenkinsfileç”ŸæˆæˆåŠŸ")
        
        # ä¿å­˜æ–‡ä»¶
        with open('integration_test_pipeline.groovy', 'w', encoding='utf-8') as f:
            f.write(jenkinsfile)
        print("âœ… Jenkinsfileå·²ä¿å­˜åˆ° integration_test_pipeline.groovy")
        
        return True
        
    except Pipeline.DoesNotExist:
        print("âŒ æœªæ‰¾åˆ°Integration Test Pipeline")
        return False
    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False


async def main():
    """ä¸»å‡½æ•°"""
    print("Jenkins XMLè½¬ä¹‰ä¿®å¤æµ‹è¯•")
    print("=" * 50)
    
    # æµ‹è¯•XMLè½¬ä¹‰ä¿®å¤
    result1 = await test_xml_escaping_fix()
    
    # æµ‹è¯•Integration Test Pipelineä¿®å¤
    result2 = await test_integration_pipeline_fix()
    
    print("\n" + "=" * 50)
    print("æµ‹è¯•ç»“æœæ±‡æ€»:")
    print(f"XMLè½¬ä¹‰ä¿®å¤: {'âœ… é€šè¿‡' if result1 else 'âŒ å¤±è´¥'}")
    print(f"Integration Pipeline: {'âœ… é€šè¿‡' if result2 else 'âŒ å¤±è´¥'}")
    
    if result1 and result2:
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Jenkins 500é”™è¯¯åº”è¯¥å·²ç»ä¿®å¤ã€‚")
        print("\nå»ºè®®:")
        print("1. éƒ¨ç½²ä¿®å¤åçš„ä»£ç ")
        print("2. é‡æ–°æµ‹è¯•æµæ°´çº¿é¢„è§ˆå’Œæ‰§è¡ŒåŠŸèƒ½")
        print("3. éªŒè¯'Integration Test Pipeline'çš„é¢„è§ˆå’Œæ‰§è¡Œä¸€è‡´æ€§")
    else:
        print("\nâš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯å¹¶è¿›ä¸€æ­¥è°ƒè¯•ã€‚")


if __name__ == "__main__":
    asyncio.run(main())
