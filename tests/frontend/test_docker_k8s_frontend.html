<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker/K8s æ­¥éª¤ç±»å‹æµ‹è¯•</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/antd@5.12.8/dist/antd.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/antd@5.12.8/dist/reset.css" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .step-preview {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #1890ff;
        }
        .step-config {
            margin-bottom: 24px;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            overflow: hidden;
        }
        .step-config-header {
            background: #fafafa;
            padding: 16px;
            border-bottom: 1px solid #e8e8e8;
            font-weight: 600;
            color: #262626;
        }
        .step-config-body {
            padding: 16px;
        }
        .success { color: #52c41a; }
        .error { color: #ff4d4f; }
        .warning { color: #fa8c16; }
        .info { color: #1890ff; }
        
        .test-result {
            margin: 16px 0;
            padding: 12px;
            border-radius: 6px;
            background: #f6f8fa;
        }
        
        .test-result.success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
        }
        
        .test-result.error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
        }
        
        .code-block {
            background: #f1f3f4;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 16px;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            margin: 12px 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { 
            Card, 
            Form, 
            Input, 
            Select, 
            Button, 
            Space, 
            Typography, 
            Alert, 
            Divider, 
            Tag,
            Switch,
            InputNumber,
            Collapse,
            Row,
            Col
        } = antd;
        
        const { Title, Text, Paragraph } = Typography;
        const { Option } = Select;
        const { Panel } = Collapse;

        // æ¨¡æ‹Ÿæ•°æ®
        const mockDockerRegistries = [
            {
                id: 1,
                name: 'Docker Hub',
                url: 'docker.io',
                is_default: true,
                is_active: true
            },
            {
                id: 2,
                name: 'Harbor Registry',
                url: 'harbor.company.com',
                is_default: false,
                is_active: true
            }
        ];

        const mockK8sClusters = [
            {
                id: 1,
                name: 'Production Cluster',
                api_server: 'https://k8s-prod.company.com:6443',
                status: 'connected',
                description: 'ç”Ÿäº§ç¯å¢ƒé›†ç¾¤'
            },
            {
                id: 2,
                name: 'Development Cluster',
                api_server: 'https://k8s-dev.company.com:6443',
                status: 'connected',
                description: 'å¼€å‘ç¯å¢ƒé›†ç¾¤'
            }
        ];

        const mockK8sNamespaces = [
            {
                id: 1,
                name: 'default',
                cluster: 1,
                status: 'active'
            },
            {
                id: 2,
                name: 'production',
                cluster: 1,
                status: 'active'
            },
            {
                id: 3,
                name: 'development',
                cluster: 2,
                status: 'active'
            }
        ];

        const dockerStepTypes = [
            { value: 'docker_build', label: 'Docker Build', description: 'æ„å»º Docker é•œåƒ' },
            { value: 'docker_run', label: 'Docker Run', description: 'è¿è¡Œ Docker å®¹å™¨' },
            { value: 'docker_push', label: 'Docker Push', description: 'æ¨é€é•œåƒåˆ°æ³¨å†Œè¡¨' },
            { value: 'docker_pull', label: 'Docker Pull', description: 'ä»æ³¨å†Œè¡¨æ‹‰å–é•œåƒ' }
        ];

        const k8sStepTypes = [
            { value: 'k8s_deploy', label: 'Kubernetes Deploy', description: 'éƒ¨ç½²åˆ° K8s é›†ç¾¤' },
            { value: 'k8s_scale', label: 'Kubernetes Scale', description: 'æ‰©ç¼©å®¹ K8s éƒ¨ç½²' },
            { value: 'k8s_delete', label: 'Kubernetes Delete', description: 'åˆ é™¤ K8s èµ„æº' },
            { value: 'k8s_wait', label: 'Kubernetes Wait', description: 'ç­‰å¾… K8s èµ„æºçŠ¶æ€' },
            { value: 'k8s_exec', label: 'Kubernetes Exec', description: 'åœ¨ Pod ä¸­æ‰§è¡Œå‘½ä»¤' },
            { value: 'k8s_logs', label: 'Kubernetes Logs', description: 'è·å– Pod æ—¥å¿—' }
        ];

        // ç®€åŒ–çš„ Docker é…ç½®ç»„ä»¶
        const DockerStepConfigTest = ({ stepType, form }) => {
            if (!stepType?.startsWith('docker_')) return null;

            return (
                <div className="step-config">
                    <div className="step-config-header">
                        ğŸ³ Docker {stepType.replace('docker_', '').toUpperCase()} é…ç½®
                    </div>
                    <div className="step-config-body">
                        <Form.Item
                            name="docker_image"
                            label="é•œåƒåç§°"
                            rules={[{ required: true, message: 'è¯·è¾“å…¥é•œåƒåç§°' }]}
                        >
                            <Input placeholder="ä¾‹å¦‚: myapp" />
                        </Form.Item>

                        <Form.Item
                            name="docker_tag"
                            label="é•œåƒæ ‡ç­¾"
                            initialValue="latest"
                        >
                            <Input placeholder="ä¾‹å¦‚: latest, v1.0.0" />
                        </Form.Item>

                        {stepType === 'docker_build' && (
                            <>
                                <Form.Item
                                    name={['docker_config', 'dockerfile_path']}
                                    label="Dockerfile è·¯å¾„"
                                >
                                    <Input placeholder="ä¾‹å¦‚: ./Dockerfile" />
                                </Form.Item>
                                <Form.Item
                                    name={['docker_config', 'context_path']}
                                    label="æ„å»ºä¸Šä¸‹æ–‡"
                                >
                                    <Input placeholder="ä¾‹å¦‚: ." />
                                </Form.Item>
                            </>
                        )}

                        {stepType === 'docker_run' && (
                            <>
                                <Form.Item
                                    name={['docker_config', 'ports']}
                                    label="ç«¯å£æ˜ å°„"
                                >
                                    <Input placeholder="ä¾‹å¦‚: 8080:80" />
                                </Form.Item>
                                <Form.Item
                                    name={['docker_config', 'detach']}
                                    valuePropName="checked"
                                >
                                    <Switch checkedChildren="åå°è¿è¡Œ" unCheckedChildren="å‰å°è¿è¡Œ" />
                                </Form.Item>
                            </>
                        )}

                        {(stepType === 'docker_push' || stepType === 'docker_pull') && (
                            <Form.Item
                                name="docker_registry"
                                label="Docker æ³¨å†Œè¡¨"
                            >
                                <Select placeholder="é€‰æ‹©æ³¨å†Œè¡¨">
                                    {mockDockerRegistries.map(registry => (
                                        <Option key={registry.id} value={registry.id}>
                                            {registry.name} ({registry.url})
                                            {registry.is_default && <Tag color="blue" style={{ marginLeft: 8 }}>é»˜è®¤</Tag>}
                                        </Option>
                                    ))}
                                </Select>
                            </Form.Item>
                        )}
                    </div>
                </div>
            );
        };

        // ç®€åŒ–çš„ K8s é…ç½®ç»„ä»¶
        const KubernetesStepConfigTest = ({ stepType, form }) => {
            if (!stepType?.startsWith('k8s_')) return null;

            return (
                <div className="step-config">
                    <div className="step-config-header">
                        â˜¸ï¸ Kubernetes {stepType.replace('k8s_', '').toUpperCase()} é…ç½®
                    </div>
                    <div className="step-config-body">
                        <Form.Item
                            name="k8s_cluster"
                            label="K8s é›†ç¾¤"
                            rules={[{ required: true, message: 'è¯·é€‰æ‹©é›†ç¾¤' }]}
                        >
                            <Select placeholder="é€‰æ‹©é›†ç¾¤">
                                {mockK8sClusters.map(cluster => (
                                    <Option key={cluster.id} value={cluster.id}>
                                        {cluster.name}
                                        <Tag color={cluster.status === 'connected' ? 'green' : 'red'} style={{ marginLeft: 8 }}>
                                            {cluster.status === 'connected' ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}
                                        </Tag>
                                    </Option>
                                ))}
                            </Select>
                        </Form.Item>

                        <Form.Item
                            name="k8s_namespace"
                            label="å‘½åç©ºé—´"
                            rules={[{ required: true, message: 'è¯·è¾“å…¥å‘½åç©ºé—´' }]}
                        >
                            <Select placeholder="é€‰æ‹©å‘½åç©ºé—´">
                                {mockK8sNamespaces.map(ns => (
                                    <Option key={ns.id} value={ns.name}>
                                        {ns.name}
                                        <Tag color="green" style={{ marginLeft: 8 }}>æ´»è·ƒ</Tag>
                                    </Option>
                                ))}
                            </Select>
                        </Form.Item>

                        <Form.Item
                            name="k8s_resource_name"
                            label="èµ„æºåç§°"
                            rules={[{ required: true, message: 'è¯·è¾“å…¥èµ„æºåç§°' }]}
                        >
                            <Input placeholder="ä¾‹å¦‚: my-app-deployment" />
                        </Form.Item>

                        {stepType === 'k8s_deploy' && (
                            <Form.Item
                                name={['k8s_config', 'manifest_path']}
                                label="Manifest æ–‡ä»¶è·¯å¾„"
                            >
                                <Input placeholder="ä¾‹å¦‚: k8s/deployment.yaml" />
                            </Form.Item>
                        )}

                        {stepType === 'k8s_scale' && (
                            <Form.Item
                                name={['k8s_config', 'replicas']}
                                label="å‰¯æœ¬æ•°é‡"
                                rules={[{ required: true, message: 'è¯·è¾“å…¥å‰¯æœ¬æ•°é‡' }]}
                            >
                                <InputNumber min={0} max={100} placeholder="3" style={{ width: '100%' }} />
                            </Form.Item>
                        )}

                        {stepType === 'k8s_wait' && (
                            <Form.Item
                                name={['k8s_config', 'condition']}
                                label="ç­‰å¾…æ¡ä»¶"
                                rules={[{ required: true, message: 'è¯·é€‰æ‹©ç­‰å¾…æ¡ä»¶' }]}
                            >
                                <Select placeholder="é€‰æ‹©æ¡ä»¶">
                                    <Option value="Available">Available</Option>
                                    <Option value="Ready">Ready</Option>
                                    <Option value="Complete">Complete</Option>
                                </Select>
                            </Form.Item>
                        )}

                        {(stepType === 'k8s_exec' || stepType === 'k8s_logs') && (
                            <Form.Item
                                name={['k8s_config', 'container_name']}
                                label="å®¹å™¨åç§°"
                            >
                                <Input placeholder="ä¾‹å¦‚: my-app-container" />
                            </Form.Item>
                        )}

                        {stepType === 'k8s_exec' && (
                            <Form.Item
                                name={['k8s_config', 'command']}
                                label="æ‰§è¡Œå‘½ä»¤"
                                rules={[{ required: true, message: 'è¯·è¾“å…¥å‘½ä»¤' }]}
                            >
                                <Input placeholder="ä¾‹å¦‚: /bin/bash -c 'echo hello'" />
                            </Form.Item>
                        )}
                    </div>
                </div>
            );
        };

        const DockerK8sStepTest = () => {
            const [form] = Form.useForm();
            const [selectedStepType, setSelectedStepType] = useState('');
            const [testResults, setTestResults] = useState([]);
            const [formValues, setFormValues] = useState({});

            const handleStepTypeChange = (value) => {
                setSelectedStepType(value);
                form.resetFields();
            };

            const handleFormChange = () => {
                const values = form.getFieldsValue();
                setFormValues(values);
            };

            const runTest = async () => {
                try {
                    const values = await form.validateFields();
                    const result = {
                        timestamp: new Date().toLocaleTimeString(),
                        success: true,
                        stepType: selectedStepType,
                        config: values,
                        message: `âœ… ${selectedStepType} é…ç½®éªŒè¯æˆåŠŸ`
                    };
                    setTestResults(prev => [result, ...prev.slice(0, 4)]);
                } catch (error) {
                    const result = {
                        timestamp: new Date().toLocaleTimeString(),
                        success: false,
                        stepType: selectedStepType,
                        error: error.errorFields,
                        message: `âŒ ${selectedStepType} é…ç½®éªŒè¯å¤±è´¥`
                    };
                    setTestResults(prev => [result, ...prev.slice(0, 4)]);
                }
            };

            const clearResults = () => {
                setTestResults([]);
            };

            return (
                <div className="container">
                    <Title level={2}>ğŸš€ Docker/K8s æ­¥éª¤ç±»å‹æµ‹è¯•</Title>
                    <Paragraph>
                        è¿™ä¸ªæµ‹è¯•é¡µé¢ç”¨äºéªŒè¯æ–°å¢çš„ Docker å’Œ Kubernetes æ­¥éª¤ç±»å‹çš„å‰ç«¯é…ç½®ç•Œé¢ã€‚
                        é€‰æ‹©ä¸åŒçš„æ­¥éª¤ç±»å‹æ¥æŸ¥çœ‹ç›¸åº”çš„é…ç½®è¡¨å•ã€‚
                    </Paragraph>

                    <Card title="æ­¥éª¤ç±»å‹é€‰æ‹©" style={{ marginBottom: 24 }}>
                        <Row gutter={16}>
                            <Col span={12}>
                                <Title level={4}>ğŸ³ Docker æ­¥éª¤</Title>
                                <Space wrap>
                                    {dockerStepTypes.map(type => (
                                        <Button
                                            key={type.value}
                                            type={selectedStepType === type.value ? 'primary' : 'default'}
                                            onClick={() => handleStepTypeChange(type.value)}
                                            style={{ marginBottom: 8 }}
                                        >
                                            {type.label}
                                        </Button>
                                    ))}
                                </Space>
                            </Col>
                            <Col span={12}>
                                <Title level={4}>â˜¸ï¸ Kubernetes æ­¥éª¤</Title>
                                <Space wrap>
                                    {k8sStepTypes.map(type => (
                                        <Button
                                            key={type.value}
                                            type={selectedStepType === type.value ? 'primary' : 'default'}
                                            onClick={() => handleStepTypeChange(type.value)}
                                            style={{ marginBottom: 8 }}
                                        >
                                            {type.label}
                                        </Button>
                                    ))}
                                </Space>
                            </Col>
                        </Row>
                    </Card>

                    {selectedStepType && (
                        <Form 
                            form={form} 
                            layout="vertical"
                            onValuesChange={handleFormChange}
                        >
                            <Card title={`é…ç½®è¡¨å• - ${selectedStepType}`} style={{ marginBottom: 24 }}>
                                <Form.Item
                                    name="name"
                                    label="æ­¥éª¤åç§°"
                                    rules={[{ required: true, message: 'è¯·è¾“å…¥æ­¥éª¤åç§°' }]}
                                >
                                    <Input placeholder="è¾“å…¥æ­¥éª¤åç§°" />
                                </Form.Item>

                                <Form.Item
                                    name="description"
                                    label="æ­¥éª¤æè¿°"
                                >
                                    <Input placeholder="è¾“å…¥æ­¥éª¤æè¿°ï¼ˆå¯é€‰ï¼‰" />
                                </Form.Item>

                                <DockerStepConfigTest stepType={selectedStepType} form={form} />
                                <KubernetesStepConfigTest stepType={selectedStepType} form={form} />

                                <Form.Item
                                    name="timeout_seconds"
                                    label="è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰"
                                    initialValue={300}
                                >
                                    <InputNumber min={1} max={3600} style={{ width: '100%' }} />
                                </Form.Item>

                                <Space>
                                    <Button type="primary" onClick={runTest}>
                                        éªŒè¯é…ç½®
                                    </Button>
                                    <Button onClick={() => form.resetFields()}>
                                        é‡ç½®è¡¨å•
                                    </Button>
                                </Space>
                            </Card>
                        </Form>
                    )}

                    {formValues && Object.keys(formValues).length > 0 && (
                        <Card title="å®æ—¶é…ç½®é¢„è§ˆ" style={{ marginBottom: 24 }}>
                            <div className="code-block">
                                {JSON.stringify(formValues, null, 2)}
                            </div>
                        </Card>
                    )}

                    {testResults.length > 0 && (
                        <Card 
                            title="æµ‹è¯•ç»“æœ" 
                            style={{ marginBottom: 24 }}
                            extra={
                                <Button onClick={clearResults}>æ¸…é™¤ç»“æœ</Button>
                            }
                        >
                            {testResults.map((result, index) => (
                                <div 
                                    key={index} 
                                    className={`test-result ${result.success ? 'success' : 'error'}`}
                                >
                                    <div style={{ fontWeight: 500, marginBottom: 8 }}>
                                        [{result.timestamp}] {result.message}
                                    </div>
                                    {result.success ? (
                                        <div className="code-block">
                                            {JSON.stringify(result.config, null, 2)}
                                        </div>
                                    ) : (
                                        <div style={{ color: '#ff4d4f' }}>
                                            éªŒè¯é”™è¯¯: {result.error?.map(err => err.errors.join(', ')).join('; ')}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </Card>
                    )}

                    <Alert
                        message="åŠŸèƒ½è¯´æ˜"
                        description={
                            <div>
                                <p><strong>Docker æ­¥éª¤ç±»å‹:</strong></p>
                                <ul>
                                    <li><code>docker_build</code>: æ„å»º Docker é•œåƒ</li>
                                    <li><code>docker_run</code>: è¿è¡Œ Docker å®¹å™¨</li>
                                    <li><code>docker_push</code>: æ¨é€é•œåƒåˆ°æ³¨å†Œè¡¨</li>
                                    <li><code>docker_pull</code>: ä»æ³¨å†Œè¡¨æ‹‰å–é•œåƒ</li>
                                </ul>
                                <p><strong>Kubernetes æ­¥éª¤ç±»å‹:</strong></p>
                                <ul>
                                    <li><code>k8s_deploy</code>: éƒ¨ç½²åº”ç”¨åˆ° K8s é›†ç¾¤</li>
                                    <li><code>k8s_scale</code>: æ‰©ç¼©å®¹ K8s éƒ¨ç½²</li>
                                    <li><code>k8s_delete</code>: åˆ é™¤ K8s èµ„æº</li>
                                    <li><code>k8s_wait</code>: ç­‰å¾… K8s èµ„æºçŠ¶æ€</li>
                                    <li><code>k8s_exec</code>: åœ¨ Pod ä¸­æ‰§è¡Œå‘½ä»¤</li>
                                    <li><code>k8s_logs</code>: è·å– Pod æ—¥å¿—</li>
                                </ul>
                            </div>
                        }
                        type="info"
                        showIcon
                    />
                </div>
            );
        };

        ReactDOM.render(<DockerK8sStepTest />, document.getElementById('root'));
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>
